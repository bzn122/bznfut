<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bzn Fut | Definitive</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; /* Indigo */
            --accent: #00f2ff; /* Cyan Neon */
            --bg: #050507;
            --card-bg: rgba(20, 20, 25, 0.9);
            --border: rgba(255, 255, 255, 0.15);
            --text: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
            --gold: #fbbf24;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Rajdhani', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            height: 100dvh; 
            display: flex; 
            justify-content: center; 
            overflow: hidden;
            background: radial-gradient(circle at 50% 0%, #1e1b4b, #000);
        }

        #app { 
            width: 100%; max-width: 480px; height: 100%; 
            display: flex; flex-direction: column; position: relative; padding: 15px;
        }

        /* ANIMACIONES */
        .screen { display: none; flex-direction: column; height: 100%; animation: slideIn 0.3s ease-out; }
        .screen.active { display: flex; }
        @keyframes slideIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        /* UI ELEMENTS */
        .card {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 20px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px);
        }

        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; background: rgba(0,0,0,0.4); border-radius: 15px; margin-bottom: 15px; border: 1px solid var(--border);
        }
        
        .btn {
            width: 100%; padding: 16px; border-radius: 14px; border: none;
            font-size: 1.1rem; font-weight: 700; cursor: pointer;
            transition: 0.2s; text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
            color: white; position: relative; overflow: hidden;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(90deg, var(--primary), #4f46e5); box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }
        .btn-glass { background: rgba(255,255,255,0.08); border: 1px solid var(--border); }
        .btn-success { background: var(--success); color: #000; box-shadow: 0 0 10px var(--success); }

        /* JUEGO */
        .scoreboard { 
            display: flex; justify-content: space-between; align-items: center;
            background: #000; padding: 15px; border-radius: 16px; border: 1px solid #333; margin-bottom: 10px;
        }
        .score-box { text-align: center; width: 45%; }
        .p-name { font-size: 0.8rem; color: #888; display: block; margin-bottom: 5px; }
        .dots-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; }
        .dot { width: 10px; height: 10px; background: #222; border-radius: 50%; transition: 0.3s; }
        .dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); transform: scale(1.2); }

        .timer-bar { width: 100%; height: 4px; background: #222; margin-bottom: 15px; }
        .timer-fill { height: 100%; background: var(--primary); transition: width 1s linear; }
        .timer-fill.danger { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

        .q-box { 
            min-height: 120px; display: flex; align-items: center; justify-content: center; text-align: center;
            font-size: 1.2rem; font-weight: 700; padding: 10px; line-height: 1.4;
        }

        .opt-btn { 
            width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); 
            border-radius: 12px; color: #ddd; text-align: left; margin-bottom: 8px; font-weight: 600;
        }
        .opt-btn:active { background: var(--accent); color: #000; }
        .opt-btn:disabled { opacity: 0.3; }
        .opt-btn.hint { border: 1px solid var(--success); background: rgba(16, 185, 129, 0.2); }

        /* ITEMS BAR FIXED */
        .items-dock { 
            margin-top: auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; 
            padding-top: 10px; border-top: 1px solid var(--border);
        }
        .item-btn { 
            background: #111; border: 1px solid #333; border-radius: 10px; padding: 10px 5px; 
            text-align: center; font-size: 0.7rem; position: relative; color: #888;
        }
        .item-btn b { display: block; color: var(--gold); font-size: 0.9rem; margin-top: 2px; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }

        /* AMIGOS */
        .friend-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 5px;
        }
        .status-led { width: 10px; height: 10px; background: #444; border-radius: 50%; margin-right: 8px; display: inline-block; }
        .status-led.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: #111; border: 1px solid var(--primary); padding: 30px; border-radius: 20px; text-align: center; width: 100%; max-width: 350px; }

        #toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 8px 20px; border-radius: 30px; font-weight: 800; z-index: 200; display: none; box-shadow: 0 0 15px var(--accent); white-space: nowrap; }
    </style>
</head>
<body>

<div id="toast">MSG</div>

<div id="app">

    <!-- LOADING -->
    <div id="screen-load" class="screen active" style="justify-content:center; align-items:center;">
        <h1 style="font-size:3rem; text-shadow:0 0 20px var(--primary);">BZN FUT</h1>
        <p style="color:var(--accent); letter-spacing:3px;">DEFINITIVE</p>
    </div>

    <!-- MENU -->
    <div id="screen-menu" class="screen">
        <div class="top-bar">
            <div><span id="u-name">Jugador</span></div>
            <div style="color:var(--gold); font-weight:bold;">ü™ô <span id="u-coins">0</span></div>
        </div>

        <div class="card" style="text-align:center; padding:40px 20px;">
            <h2 style="font-size:2.5rem; margin-bottom:5px;">BZN FUT</h2>
            <small style="color:#666; letter-spacing:2px;">SEASON 2025</small>
        </div>

        <div style="display:flex; flex-direction:column; gap:5px;">
            <button class="btn btn-primary" onclick="startGame('career')">üèÜ MODO CARRERA</button>
            <button class="btn btn-primary" style="background:linear-gradient(90deg, #ec4899, #8b5cf6);" onclick="goToOnline()">‚öîÔ∏è ONLINE HUB</button>
            <button class="btn btn-glass" onclick="startGame('bot')">ü§ñ VS BOT</button>
            <button class="btn btn-glass" onclick="setScreen('screen-shop')">üõí MERCADO</button>
            <button class="btn btn-glass" onclick="setScreen('screen-settings')">‚öôÔ∏è AJUSTES</button>
        </div>
    </div>

    <!-- ONLINE HUB -->
    <div id="screen-online" class="screen">
        <div class="top-bar"><span onclick="closeOnline()">‚Äπ MENU</span> <span>ONLINE</span></div>
        
        <div class="card">
            <button class="btn btn-primary" onclick="createRoom()">üìù CREAR SALA (HOST)</button>
            <button class="btn btn-glass" onclick="setScreen('screen-join')">üöÄ UNIRSE (CLIENT)</button>
        </div>

        <h4 style="color:#666; margin:10px 0;">AMIGOS GUARDADOS</h4>
        <div id="friend-list-container" style="flex:1; overflow-y:auto;">
            <!-- Lista dinamica -->
        </div>
    </div>

    <!-- HOST -->
    <div id="screen-host" class="screen" style="text-align:center;">
        <h3 style="margin-top:20px; color:#888;">TU C√ìDIGO</h3>
        <div class="card">
            <h1 id="host-id-disp" style="font-size:2.5rem; color:var(--accent); letter-spacing:2px;">...</h1>
        </div>
        <p>Comparte este c√≥digo para jugar.</p>
        <button class="btn btn-glass" style="margin-top:auto;" onclick="location.reload()">CANCELAR</button>
    </div>

    <!-- JOIN -->
    <div id="screen-join" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-online')">‚Äπ VOLVER</span></div>
        <div class="card">
            <h3>INGRESAR C√ìDIGO</h3>
            <input id="join-input" style="width:100%; padding:20px; background:#000; border:1px solid #333; color:white; font-size:1.5rem; text-align:center; border-radius:12px; margin:20px 0; text-transform:uppercase;" placeholder="EJ: BZN-99">
            <button class="btn btn-primary" onclick="connectToPeer()">CONECTAR</button>
        </div>
    </div>

    <!-- GAME -->
    <div id="screen-game" class="screen">
        <div class="scoreboard">
            <div class="score-box">
                <span class="p-name">YO</span>
                <div class="dots-row" id="dots-me"></div>
            </div>
            <div style="font-weight:900;">VS</div>
            <div class="score-box">
                <span class="p-name" id="rival-name">RIVAL</span>
                <div class="dots-row" id="dots-op"></div>
            </div>
        </div>
        
        <div style="text-align:center; font-size:0.7rem; color:#666; margin-bottom:5px;" id="hist-disp">HISTORIAL: 0 - 0</div>
        
        <div style="width:100%; height:6px; background:#222; border-radius:3px; overflow:hidden; margin-bottom:15px;">
            <div class="timer-fill" id="timer-bar"></div>
        </div>

        <div class="card q-box" id="q-text">...</div>
        <div id="options-area"></div>

        <button id="btn-add-friend" class="btn btn-success" style="display:none; padding:10px; font-size:0.8rem; margin-top:5px;" onclick="sendFriendRequest()">
            + ENVIAR SOLICITUD DE AMISTAD
        </button>

        <div class="items-dock">
            <div class="item-btn" onclick="useItem('var')">
                üì∫ VAR <div class="badge" id="b-var">0</div>
            </div>
            <div class="item-btn" onclick="useItem('hint')">
                üì£ HINCHADA <div class="badge" id="b-hint">0</div>
            </div>
            <div class="item-btn" onclick="useItem('time')">
                ‚è≥ EXTRA <div class="badge" id="b-time">0</div>
            </div>
        </div>
    </div>

    <!-- TIENDA -->
    <div id="screen-shop" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ VOLVER</span></div>
        <div class="card">
            <div class="friend-item">
                <div><b>üì∫ VAR</b><small style="color:#666; display:block;">Borra 2 opciones</small></div>
                <button class="btn btn-glass" style="width:auto; padding:8px 15px;" onclick="buyItem('var', 50)">$50</button>
            </div>
            <div class="friend-item">
                <div><b>üì£ HINCHADA</b><small style="color:#666; display:block;">Marca correcta</small></div>
                <button class="btn btn-glass" style="width:auto; padding:8px 15px;" onclick="buyItem('hint', 40)">$40</button>
            </div>
            <div class="friend-item">
                <div><b>‚è≥ EXTRA</b><small style="color:#666; display:block;">+20 Segundos</small></div>
                <button class="btn btn-glass" style="width:auto; padding:8px 15px;" onclick="buyItem('time', 30)">$30</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="screen-settings" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ VOLVER</span></div>
        <div class="card">
            <p>NOMBRE</p>
            <input id="inp-name" style="width:100%; padding:15px; background:#000; border:1px solid #333; color:white; border-radius:10px; margin-bottom:10px;">
            <button class="btn btn-primary" onclick="saveData()">GUARDAR</button>
            <button class="btn btn-glass" style="margin-top:20px; color:var(--danger); border-color:var(--danger);" onclick="resetData()">BORRAR TODO</button>
        </div>
    </div>

    <!-- MODAL FIN -->
    <div id="modal-end" class="modal">
        <div class="modal-box">
            <h1 id="end-title" style="font-size:3rem;">FIN</h1>
            <p id="end-msg" style="color:#888; margin-bottom:20px;">...</p>
            <button class="btn btn-primary" onclick="reqRematch()">üîÑ REVANCHA</button>
            <button class="btn btn-glass" onclick="quitGame()">SALIR</button>
            <p id="rematch-status" style="color:var(--accent); margin-top:10px; display:none;">Esperando...</p>
        </div>
    </div>

    <!-- MODAL AMISTAD -->
    <div id="modal-friend" class="modal">
        <div class="modal-box">
            <h3>SOLICITUD DE AMISTAD</h3>
            <p id="friend-req-name" style="color:var(--primary); font-size:1.5rem; margin:10px 0;">...</p>
            <p style="color:#888; margin-bottom:20px;">Quiere ser tu amigo</p>
            <button class="btn btn-success" onclick="acceptFriend()">ACEPTAR</button>
            <button class="btn btn-glass" onclick="closeModal('modal-friend')">RECHAZAR</button>
        </div>
    </div>

</div>

<script>
    // --- DATABASE ---
    const DB = [
        // Actualizados 2024/2025
        {q:"¬øClub actual de Juli√°n √Ålvarez (2025)?", a:["Atl√©tico Madrid", "Man. City", "Barcelona", "PSG"], c:0},
        {q:"¬øClub actual de Kylian Mbapp√©?", a:["Real Madrid", "PSG", "Liverpool", "Arsenal"], c:0},
        {q:"¬øCampe√≥n Libertadores 2024?", a:["Botafogo", "Atl. Mineiro", "River", "Pe√±arol"], c:0},
        {q:"¬øCampe√≥n Eurocopa 2024?", a:["Espa√±a", "Inglaterra", "Francia", "Alemania"], c:0},
        {q:"¬øClub actual de Enzo Fern√°ndez?", a:["Chelsea", "Benfica", "Real Madrid", "Liverpool"], c:0},
        {q:"¬øCampe√≥n Copa Am√©rica 2024?", a:["Argentina", "Colombia", "Uruguay", "Brasil"], c:0},
        {q:"¬øD√≥nde juega Alexis Mac Allister?", a:["Liverpool", "Brighton", "Juventus", "Boca"], c:0},
        {q:"¬øQui√©n es el DT de Selecci√≥n Argentina?", a:["Scaloni", "Sampaoli", "Martino", "Bielsa"], c:0},
        {q:"¬øQu√© Selecci√≥n gan√≥ Qatar 2022?", a:["Argentina", "Francia", "Croacia", "Marruecos"], c:0},
        {q:"¬øM√°ximo goleador hist√≥rico de Uruguay?", a:["Luis Su√°rez", "Cavani", "Forl√°n", "N√∫√±ez"], c:0},
        {q:"¬øClub actual del Dibu Mart√≠nez?", a:["Aston Villa", "Arsenal", "West Ham", "Everton"], c:0},
        {q:"¬øQui√©n gan√≥ la Champions 2024?", a:["Real Madrid", "Dortmund", "Bayern", "Man. City"], c:0},
        {q:"¬øApodo de la Selecci√≥n Espa√±ola?", a:["La Roja", "La Furia", "Los Toros", "Azul"], c:0},
        {q:"¬øEstadio de la final Mundial 2026?", a:["MetLife (USA)", "Azteca", "Toronto", "Rose Bowl"], c:0},
        {q:"¬øEquipo de Messi en 2025?", a:["Inter Miami", "Barcelona", "Newell's", "PSG"], c:0},
        {q:"¬øCu√°ntas Champions tiene el Real Madrid?", a:["15", "14", "13", "16"], c:0},
        {q:"¬øQui√©n gan√≥ la Sudamericana 2024?", a:["Racing", "Cruzeiro", "Lan√∫s", "Corinthians"], c:0}, // Predicci√≥n/Actualizaci√≥n Racing lleg√≥ a final en 2024 real
        {q:"¬øApodo de Selecci√≥n Brasile√±a?", a:["Canarinha", "Verdeamarela", "Scratch", "Todas"], c:3},
        {q:"¬øClub de Lautaro Mart√≠nez?", a:["Inter de Mil√°n", "Racing", "Atl√©tico", "Barcelona"], c:0},
        {q:"¬øCampe√≥n del Mundo 1986?", a:["Argentina", "Alemania", "Brasil", "Italia"], c:0}
    ];

    // --- STATE ---
    let db = JSON.parse(localStorage.getItem('bzn_fut_v14')) || {
        name: 'Jugador', coins: 100, items: {var:3, hint:3, time:3}, 
        friends: [], // {id, name}
        history: {} // {id: {w:0, l:0}}
    };

    let state = {
        mode: null, myG:0, opG:0, timer:null, timeLeft:20,
        rival: {id:null, name:'BOT'}, usedQ: [], 
        rematchMe: false, rematchOp: false, pendingFriend: null
    };

    let peer, conn;

    // --- INIT ---
    window.onload = () => {
        setTimeout(() => setScreen(db.name === 'Jugador' ? 'screen-settings' : 'screen-menu'), 1000);
        updateUI();
    };

    // --- NAVIGATION ---
    function setScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'screen-online') startRadar(); // PING AMIGOS
    }

    function updateUI() {
        document.getElementById('u-name').innerText = db.name;
        document.getElementById('u-coins').innerText = db.coins;
        document.getElementById('b-var').innerText = db.items.var;
        document.getElementById('b-hint').innerText = db.items.hint;
        document.getElementById('b-time').innerText = db.items.time;
        document.getElementById('inp-name').value = db.name;
    }

    function saveData() {
        db.name = document.getElementById('inp-name').value;
        localStorage.setItem('bzn_fut_v14', JSON.stringify(db));
        updateUI();
    }

    function toast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1500);
    }

    // --- ONLINE SYSTEM ---
    function goToOnline() { setScreen('screen-online'); renderFriends(); }
    
    function createRoom() {
        setScreen('screen-host');
        const code = 'BZN-' + Math.floor(Math.random()*9999);
        document.getElementById('host-id-disp').innerText = code;
        peer = new Peer(code);
        peer.on('connection', c => { conn = c; setupConn('HOST'); });
    }

    function connectToPeer(targetId) {
        const id = targetId || document.getElementById('join-input').value.toUpperCase();
        if(!id) return toast("Falta ID");
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id);
            setupConn('CLIENT');
        });
    }

    function setupConn(role) {
        conn.on('open', () => {
            conn.send({type:'hello', name:db.name, id:peer.id});
        });
        conn.on('data', d => {
            if(d.type === 'hello') {
                state.rival = {id: d.id, name: d.name};
                if(role === 'HOST') conn.send({type:'hello', name:db.name, id:peer.id});
                
                // Check if friend
                const isFriend = db.friends.find(f => f.id === d.id);
                document.getElementById('btn-add-friend').style.display = isFriend ? 'none' : 'block';
                
                startGame('online');
            }
            if(d.type === 'goal') handleOpGoal();
            if(d.type === 'rematch') {
                state.rematchOp = true;
                if(state.rematchMe) startGame('online');
                else document.getElementById('rematch-status').style.display = 'block';
            }
            if(d.type === 'friend_req') {
                state.pendingFriend = {id: d.id, name: d.name};
                document.getElementById('friend-req-name').innerText = d.name;
                document.getElementById('modal-friend').style.display = 'flex';
            }
            if(d.type === 'friend_accept') {
                if(!db.friends.find(f => f.id === d.id)) {
                    db.friends.push({id: d.id, name: d.name});
                    saveData();
                    toast(d.name + " acept√≥ tu solicitud!");
                }
            }
            if(d.type === 'ping') {
                conn.send({type:'pong', id:peer.id}); // Auto-reply for radar
            }
        });
    }

    // --- FRIEND SYSTEM ---
    function sendFriendRequest() {
        if(conn && conn.open) {
            conn.send({type:'friend_req', id:peer.id, name:db.name});
            toast("Solicitud enviada");
            document.getElementById('btn-add-friend').style.display = 'none';
        }
    }

    function acceptFriend() {
        const newF = state.pendingFriend;
        if(!db.friends.find(f => f.id === newF.id)) {
            db.friends.push(newF);
            saveData();
        }
        if(conn && conn.open) conn.send({type:'friend_accept', id:peer.id, name:db.name});
        closeModal('modal-friend');
        toast("Amigo agregado");
    }

    function renderFriends() {
        const l = document.getElementById('friend-list-container'); l.innerHTML = '';
        if(db.friends.length === 0) l.innerHTML = '<p style="text-align:center; color:#666">Sin amigos</p>';
        db.friends.forEach(f => {
            const div = document.createElement('div'); div.className = 'friend-item';
            div.innerHTML = `<div><span class="status-led" id="st-${f.id}"></span><b>${f.name}</b></div>
                             <button class="btn-glass" style="width:auto; padding:5px 10px;" onclick="connectToPeer('${f.id}')">INVITAR</button>`;
            l.appendChild(div);
        });
    }

    function startRadar() {
        // Simple Radar: Try to connect to friends to see if online
        db.friends.forEach(f => {
            let p = new Peer();
            p.on('open', () => {
                let c = p.connect(f.id);
                if(c) {
                    c.on('open', () => {
                        document.getElementById(`st-${f.id}`).classList.add('online');
                        c.close();
                    });
                }
            });
        });
    }

    // --- GAME ENGINE ---
    function startGame(mode) {
        state.mode = mode; state.myG = 0; state.opG = 0; state.rematchMe = false; state.rematchOp = false;
        state.usedQ = [];
        
        if(mode !== 'online') state.rival = {id:null, name:'BOT'};
        
        document.getElementById('rival-name').innerText = state.rival.name;
        document.getElementById('modal-end').style.display = 'none';
        document.getElementById('rematch-status').style.display = 'none';
        
        // Historial
        if(state.rival.id) {
            const h = db.history[state.rival.id] || {w:0, l:0};
            document.getElementById('hist-disp').innerText = `HISTORIAL: ${h.w} - ${h.l}`;
        } else {
            document.getElementById('hist-disp').innerText = "";
        }

        setScreen('screen-game');
        updateScore();
        nextQ();
    }

    function nextQ() {
        clearInterval(state.timer);
        state.timeLeft = 20;
        startTimer();

        // Filter used questions
        let available = DB.filter(q => !state.usedQ.includes(q.q));
        if(available.length === 0) { state.usedQ = []; available = DB; } // Reset deck
        
        const q = available[Math.floor(Math.random() * available.length)];
        state.usedQ.push(q.q);

        document.getElementById('q-text').innerText = q.q;
        const area = document.getElementById('options-area'); area.innerHTML = '';
        
        let idx = [0,1,2,3].sort(()=>Math.random()-0.5);
        idx.forEach(i => {
            const b = document.createElement('button'); b.className = 'opt-btn';
            b.innerText = q.a[i]; b.dataset.correct = (i === q.c);
            b.onclick = () => answer(i === q.c);
            area.appendChild(b);
        });
    }

    function startTimer() {
        const b = document.getElementById('timer-bar'); b.className='timer-fill';
        state.timer = setInterval(() => {
            state.timeLeft--;
            b.style.width = (state.timeLeft/20*100)+'%';
            if(state.timeLeft<5) b.className='timer-fill danger';
            if(state.timeLeft<=0) { clearInterval(state.timer); punish(); }
        }, 1000);
    }

    function answer(ok) {
        clearInterval(state.timer);
        if(ok) {
            state.myG++; toast("¬°GOL!"); db.coins+=5;
            if(state.mode==='online' && conn) conn.send({type:'goal'});
        } else {
            toast("¬°FALLASTE!"); punish(); return;
        }
        saveDB(); updateScore(); checkEnd();
        if(!isEnd()) setTimeout(nextQ, 1000);
    }

    function punish() {
        if(state.myG>0) state.myG--; else state.opG++;
        updateScore(); checkEnd();
        if(!isEnd()) setTimeout(nextQ, 1000);
    }

    function handleOpGoal() { state.opG++; updateScore(); checkEnd(); }

    function updateScore() {
        drawDots(state.myG, 'dots-me'); drawDots(state.opG, 'dots-op');
    }

    function drawDots(n, id) {
        const el = document.getElementById(id); el.innerHTML = '';
        for(let i=0;i<10;i++) el.innerHTML += `<div class="dot ${i<n?'active':''}"></div>`;
    }

    function isEnd() { return state.myG>=10 || state.opG>=10; }

    function checkEnd() {
        if(state.myG>=10) end(true); else if(state.opG>=10) end(false);
    }

    function end(win) {
        clearInterval(state.timer);
        const m = document.getElementById('modal-end'); m.style.display='flex';
        document.getElementById('end-title').innerText = win ? "VICTORIA" : "DERROTA";
        document.getElementById('end-msg').innerText = win ? "+50 Monedas" : "Sigue intentando";
        
        if(win) db.coins += 50;
        
        // Save History
        if(state.rival.id) {
            if(!db.history[state.rival.id]) db.history[state.rival.id] = {w:0, l:0};
            if(win) db.history[state.rival.id].w++; else db.history[state.rival.id].l++;
        }
        saveDB();
    }

    function reqRematch() {
        state.rematchMe = true;
        document.getElementById('rematch-status').style.display='block';
        if(state.mode === 'bot') setTimeout(()=>startGame('bot'), 1500);
        else if(conn) conn.send({type:'rematch'});
        
        if(state.rematchOp) startGame('online');
    }

    function quitGame() { clearInterval(state.timer); setScreen('screen-menu'); document.getElementById('modal-end').style.display='none'; }

    // --- ITEMS ---
    function buyItem(t, c) {
        if(db.coins>=c) { db.coins-=c; db.items[t]++; saveDB(); toast("COMPRADO"); }
        else toast("Falta dinero");
    }

    function useItem(t) {
        if(db.items[t]>0) {
            db.items[t]--; saveDB(); updateUI();
            const btns = document.querySelectorAll('.opt-btn');
            if(t==='var') {
                let h=0; btns.forEach(b=>{ if(b.dataset.correct==='false' && h<2){ b.disabled=true; b.style.opacity=0.2; h++; } });
            }
            if(t==='hint') btns.forEach(b=>{ if(b.dataset.correct==='true') b.classList.add('hint'); });
            if(t==='time') { clearInterval(state.timer); state.timeLeft=20; startTimer(); }
        } else toast("Sin items");
    }

    // --- UTILS ---
    function closeOnline() { 
        if(peer) peer.destroy(); 
        setScreen('screen-menu'); 
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function resetData() { localStorage.removeItem('bzn_fut_v14'); location.reload(); }
</script>
</body>
</html>
