<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bzn Fut | Pure Competition v16</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --accent: #00f2ff;
            --bg: #050507;
            --surface: #121216;
            --text: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
            --gold: #fbbf24;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Rajdhani', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            background-color: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; overflow: hidden;
            background: radial-gradient(circle at 50% 0%, #171720, #000);
        }

        #app { width: 100%; max-width: 480px; height: 100%; display: flex; flex-direction: column; position: relative; padding: 15px; }

        /* SCREENS */
        .screen { display: none; flex-direction: column; height: 100%; animation: fade 0.3s ease-out; }
        .screen.active { display: flex; }
        @keyframes fade { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        /* UI KIT */
        .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-bottom: 15px; backdrop-filter: blur(10px); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; color: white; margin-bottom: 8px; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(90deg, var(--primary), #6366f1); box-shadow: 0 0 15px rgba(99, 102, 241, 0.2); }
        .btn-glass { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); }
        .btn-success { background: var(--success); color: #000; }

        /* GAME UI */
        .scoreboard { background: #000; padding: 10px; border-radius: 16px; border: 1px solid #333; margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        .score-row { display: flex; justify-content: space-between; align-items: center; }
        .p-name { font-size: 0.8rem; color: #888; width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .dots-container { display: flex; gap: 3px; flex: 1; justify-content: flex-end; }
        .dot { width: 8px; height: 8px; background: #222; border-radius: 50%; border: 1px solid #333; transition: 0.3s; }
        .dot.active { background: var(--accent); box-shadow: 0 0 5px var(--accent); border-color: var(--accent); transform: scale(1.2); }

        .hist-badge { text-align: center; font-size: 0.75rem; color: var(--gold); margin-bottom: 5px; background: rgba(251, 191, 36, 0.1); padding: 2px 10px; border-radius: 10px; align-self: center; border: 1px solid rgba(251, 191, 36, 0.2); }

        .timer-bar { width: 100%; height: 4px; background: #222; margin-bottom: 10px; border-radius: 2px; }
        .timer-fill { height: 100%; background: var(--primary); transition: width 0.2s linear; }
        .timer-fill.danger { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

        .q-box { min-height: 110px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 1.2rem; font-weight: 700; padding: 10px; line-height: 1.3; }
        .opt-btn { width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: #ddd; text-align: left; margin-bottom: 6px; font-weight: 600; font-size: 1rem; transition: 0.2s; }
        .opt-btn:active { background: var(--accent); color: #000; }
        .opt-btn:disabled { opacity: 0.3; }
        .opt-btn.hint { border: 1px solid var(--success); background: rgba(16, 185, 129, 0.2); }

        /* TAUNTS */
        .taunt-bar { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
        .taunt-btn { width: 45px; height: 45px; border-radius: 50%; background: #1a1a1a; border: 1px solid #333; font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .taunt-btn:active { transform: scale(0.9); border-color: var(--accent); }

        .floating-taunt { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 4rem; z-index: 500; animation: popUp 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; pointer-events: none; text-shadow: 0 0 20px black; }
        @keyframes popUp { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 80% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -80%) scale(1.5); opacity: 0; } }

        /* ITEMS */
        .items-dock { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .item-btn { background: #111; border: 1px solid #333; border-radius: 10px; padding: 8px; text-align: center; font-size: 0.7rem; position: relative; color: #888; }
        .item-btn b { display: block; color: var(--gold); font-size: 0.9rem; margin-top: 2px; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: #111; border: 1px solid var(--primary); padding: 30px; border-radius: 20px; text-align: center; width: 100%; max-width: 350px; box-shadow: 0 0 30px rgba(79, 70, 229, 0.3); }

        #toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 8px 24px; border-radius: 30px; font-weight: 800; z-index: 200; box-shadow: 0 0 15px var(--accent); display: none; white-space: nowrap; }
    </style>
</head>
<body>

<div id="toast">MSG</div>
<div id="taunt-layer"></div>

<div id="app">

    <!-- MENU -->
    <div id="screen-menu" class="screen active">
        <div class="top-bar">
            <div><span id="u-name" style="font-weight:bold;">Jugador</span></div>
            <div style="color:var(--gold);">ü™ô <span id="u-coins">0</span></div>
        </div>
        <div class="card" style="text-align:center;">
            <h1 style="font-size:3rem; margin-bottom:5px;">BZN FUT</h1>
            <small style="color:var(--accent); letter-spacing:2px;">PURE COMPETITION v16</small>
        </div>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <button class="btn btn-primary" onclick="goToOnline()">‚öîÔ∏è ONLINE HUB</button>
            <button class="btn btn-glass" onclick="startLibertadores()">üèÜ LIBERTADORES</button>
            <button class="btn btn-glass" onclick="startGame('bot')">ü§ñ VS BOT</button>
            <button class="btn btn-glass" onclick="startSurvival()">üíÄ SURVIVAL</button>
            <button class="btn btn-glass" onclick="setScreen('screen-shop')">üõí MERCADO</button>
            <button class="btn btn-glass" onclick="setScreen('screen-settings')">‚öôÔ∏è AJUSTES</button>
        </div>
    </div>

    <!-- ONLINE HUB -->
    <div id="screen-online" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ MENU</span> <span>ONLINE</span></div>
        <div class="card">
            <button class="btn btn-primary" onclick="createRoom()">üìù CREAR SALA</button>
            <button class="btn btn-glass" onclick="setScreen('screen-join')">üöÄ UNIRSE</button>
        </div>
        <h4 style="color:#666; margin:10px 0;">AMIGOS</h4>
        <div id="friend-list-container" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- HOST / JOIN -->
    <div id="screen-host" class="screen" style="text-align:center; justify-content:center;">
        <h3 style="color:#888;">TU C√ìDIGO</h3>
        <h1 id="host-id-disp" style="font-size:3rem; color:var(--accent); margin:20px 0;">...</h1>
        <button class="btn btn-glass" onclick="location.reload()">CANCELAR</button>
    </div>

    <div id="screen-join" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-online')">‚Äπ VOLVER</span></div>
        <div class="card">
            <input id="join-input" style="width:100%; padding:20px; background:#000; border:1px solid #333; color:white; font-size:1.5rem; text-align:center; border-radius:12px; text-transform:uppercase;" placeholder="ID SALA">
            <button class="btn btn-primary" style="margin-top:10px;" onclick="connectToPeer()">CONECTAR</button>
        </div>
    </div>

    <!-- JUEGO -->
    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:center;">
            <div class="hist-badge" id="hist-disp">HISTORIAL: 0 - 0</div>
        </div>

        <div class="scoreboard">
            <div class="score-row">
                <span class="p-name">YO</span>
                <div class="dots-container" id="dots-me"></div>
            </div>
            <div style="height:1px; background:#222; margin:5px 0;"></div>
            <div class="score-row">
                <span class="p-name" id="rival-name">RIVAL</span>
                <div class="dots-container" id="dots-op"></div>
            </div>
        </div>

        <div class="timer-bar"><div class="timer-fill" id="timer-bar"></div></div>

        <div class="taunt-bar">
            <button class="taunt-btn" onclick="sendTaunt('üëª')">üëª</button>
            <button class="taunt-btn" onclick="sendTaunt('ü§°')">ü§°</button>
            <button class="taunt-btn" onclick="sendTaunt('ü§´')">ü§´</button>
            <button class="taunt-btn" onclick="sendTaunt('ü•∂')">ü•∂</button>
        </div>

        <div class="card q-box" id="q-text">...</div>
        <div id="options-area" style="display:flex; flex-direction:column;"></div>

        <button id="btn-add-friend" class="btn btn-success" style="display:none; padding:10px; font-size:0.8rem; margin-top:5px;" onclick="sendFriendRequest()">+ AGREGAR A AMIGOS</button>

        <div class="items-dock">
            <div class="item-btn" onclick="useItem('var')">üì∫ VAR <div class="badge" id="b-var">0</div></div>
            <div class="item-btn" onclick="useItem('hint')">üì£ HINCHADA <div class="badge" id="b-hint">0</div></div>
            <div class="item-btn" onclick="useItem('time')">‚è≥ EXTRA <div class="badge" id="b-time">0</div></div>
        </div>
    </div>

    <!-- MODAL FIN -->
    <div id="modal-end" class="modal">
        <div class="modal-box">
            <h1 id="end-title" style="font-size:3rem; margin-bottom:10px;">FIN</h1>
            <p id="end-msg" style="color:#888; margin-bottom:20px;">...</p>
            <button class="btn btn-primary" onclick="reqRematch()">üîÑ PEDIR REVANCHA</button>
            <button class="btn btn-glass" onclick="quitGame()">SALIR AL MENU</button>
            <p id="rematch-status" style="color:var(--accent); margin-top:10px; display:none;">Esperando...</p>
        </div>
    </div>

    <!-- TIENDA -->
    <div id="screen-shop" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ VOLVER</span></div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; padding:10px;"><span>üì∫ VAR</span> <button class="btn btn-glass" style="width:auto; padding:5px 15px;" onclick="buyItem('var', 50)">$50</button></div>
            <div style="display:flex; justify-content:space-between; padding:10px;"><span>üì£ HINCHADA</span> <button class="btn btn-glass" style="width:auto; padding:5px 15px;" onclick="buyItem('hint', 40)">$40</button></div>
            <div style="display:flex; justify-content:space-between; padding:10px;"><span>‚è≥ EXTRA</span> <button class="btn btn-glass" style="width:auto; padding:5px 15px;" onclick="buyItem('time', 30)">$30</button></div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="screen-settings" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ VOLVER</span></div>
        <div class="card">
            <p>NOMBRE</p>
            <input id="inp-name" style="width:100%; padding:15px; background:#000; border:1px solid #333; color:white; border-radius:10px; margin-bottom:10px;">
            <button class="btn btn-primary" onclick="saveData()">GUARDAR</button>
            <button class="btn btn-glass" style="margin-top:20px; color:var(--danger); border-color:var(--danger);" onclick="resetData()">BORRAR TODO</button>
        </div>
    </div>

    <!-- MODAL AMISTAD -->
    <div id="modal-friend" class="modal">
        <div class="modal-box">
            <h3>SOLICITUD</h3>
            <p id="friend-req-name" style="color:var(--primary); font-size:1.5rem; margin:10px 0;">...</p>
            <button class="btn btn-success" onclick="acceptFriend()">ACEPTAR</button>
            <button class="btn btn-glass" onclick="document.getElementById('modal-friend').style.display='none'">RECHAZAR</button>
        </div>
    </div>

</div>

<script>
    // --- DATABASE (ID unico para evitar repeticion) ---
    const DB = [
        {id:1, q:"¬øClub actual de Juli√°n √Ålvarez?", a:["Atl√©tico Madrid", "Man. City", "River", "Barcelona"], c:0},
        {id:2, q:"¬øClub actual de Mbapp√©?", a:["Real Madrid", "PSG", "Monaco", "Liverpool"], c:0},
        {id:3, q:"¬øCampe√≥n Libertadores 2024?", a:["Botafogo", "Atl. Mineiro", "River", "Pe√±arol"], c:0},
        {id:4, q:"¬øCampe√≥n Eurocopa 2024?", a:["Espa√±a", "Inglaterra", "Francia", "Alemania"], c:0},
        {id:5, q:"¬øD√≥nde juega Enzo Fern√°ndez?", a:["Chelsea", "Benfica", "Real Madrid", "Liverpool"], c:0},
        {id:6, q:"¬øCampe√≥n Copa Am√©rica 2024?", a:["Argentina", "Colombia", "Uruguay", "Brasil"], c:0},
        {id:7, q:"¬øD√≥nde juega Mac Allister?", a:["Liverpool", "Brighton", "Juventus", "Boca"], c:0},
        {id:8, q:"¬øDT de Selecci√≥n Argentina?", a:["Scaloni", "Sampaoli", "Martino", "Bielsa"], c:0},
        {id:9, q:"¬øQui√©n gan√≥ Qatar 2022?", a:["Argentina", "Francia", "Croacia", "Marruecos"], c:0},
        {id:10, q:"¬øClub del Dibu Mart√≠nez?", a:["Aston Villa", "Arsenal", "West Ham", "Everton"], c:0},
        {id:11, q:"¬øCampe√≥n Champions 2024?", a:["Real Madrid", "Dortmund", "Bayern", "Man. City"], c:0},
        {id:12, q:"¬øApodo Selecci√≥n Espa√±ola?", a:["La Roja", "La Furia", "Los Toros", "Azul"], c:0},
        {id:13, q:"¬øSede Final Mundial 2026?", a:["MetLife (USA)", "Azteca", "Toronto", "Rose Bowl"], c:0},
        {id:14, q:"¬øEquipo de Messi 2025?", a:["Inter Miami", "Barcelona", "Newell's", "PSG"], c:0},
        {id:15, q:"¬øChampions del Real Madrid?", a:["15", "14", "13", "16"], c:0},
        {id:16, q:"¬øCampe√≥n Sudamericana 2024?", a:["Racing", "Cruzeiro", "Lan√∫s", "Corinthians"], c:0},
        {id:17, q:"¬øApodo Selecci√≥n Brasil?", a:["Canarinha", "Verdeamarela", "Scratch", "Todas"], c:3},
        {id:18, q:"¬øClub de Lautaro Mart√≠nez?", a:["Inter", "Racing", "Atl√©tico", "Barcelona"], c:0},
        {id:19, q:"¬øCampe√≥n Mundial 1986?", a:["Argentina", "Alemania", "Brasil", "Italia"], c:0},
        {id:20, q:"¬øDorsal de Lamine Yamal?", a:["19", "10", "27", "7"], c:0}
    ];

    // --- STATE ---
    let db = JSON.parse(localStorage.getItem('bzn_fut_v16')) || {
        name: 'Jugador', coins: 100, items: {var:3, hint:3, time:3}, 
        friends: [], history: {} // {id: {w:0, l:0}}
    };

    let state = {
        mode: null, myG:0, opG:0, timer:null, timeLeft:20,
        rival: {id:null, name:'BOT'}, usedQ: [], 
        rematchMe: false, rematchOp: false, pendingFriend: null,
        libRound: 0, survScore: 0
    };

    let peer, conn;

    // --- INIT ---
    window.onload = () => {
        if(db.name !== 'Jugador') setScreen('screen-menu'); else setScreen('screen-settings');
        updateUI();
    };

    // --- UTILS ---
    function setScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='screen-online') renderFriends();
    }

    function updateUI() {
        document.getElementById('u-name').innerText = db.name;
        document.getElementById('u-coins').innerText = db.coins;
        document.getElementById('b-var').innerText = db.items.var;
        document.getElementById('b-hint').innerText = db.items.hint;
        document.getElementById('b-time').innerText = db.items.time;
        document.getElementById('inp-name').value = db.name;
    }

    function saveData() { 
        db.name = document.getElementById('inp-name').value;
        localStorage.setItem('bzn_fut_v16', JSON.stringify(db)); 
        updateUI(); 
    }
    
    function resetData() { localStorage.removeItem('bzn_fut_v16'); location.reload(); }
    function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 1500); }

    // --- ONLINE ---
    function goToOnline() { setScreen('screen-online'); renderFriends(); }
    function createRoom() {
        setScreen('screen-host');
        const code = 'BZN-'+Math.floor(Math.random()*9999);
        document.getElementById('host-id-disp').innerText = code;
        peer = new Peer(code);
        peer.on('connection', c => { conn = c; setupConn('HOST'); });
    }
    function connectToPeer(tid) {
        const id = tid || document.getElementById('join-input').value.toUpperCase();
        if(!id) return toast("Falta ID");
        peer = new Peer();
        peer.on('open', () => { conn = peer.connect(id); setupConn('CLIENT'); });
    }
    function setupConn(role) {
        conn.on('open', () => { conn.send({type:'hello', name:db.name, id:peer.id}); });
        conn.on('data', d => {
            if(d.type==='hello') {
                state.rival = {id:d.id, name:d.name};
                if(role==='HOST') conn.send({type:'hello', name:db.name, id:peer.id});
                
                const isFriend = db.friends.find(f => f.id === d.id);
                document.getElementById('btn-add-friend').style.display = isFriend ? 'none' : 'block';
                startGame('online');
            }
            if(d.type==='goal') handleOpGoal();
            if(d.type==='rematch') { state.rematchOp=true; checkRematch(); }
            if(d.type==='taunt') showTaunt(d.emoji);
            if(d.type==='req_friend') {
                state.pendingFriend = {id:d.id, name:d.name};
                document.getElementById('friend-req-name').innerText = d.name;
                document.getElementById('modal-friend').style.display='flex';
            }
            if(d.type==='acc_friend') {
                if(!db.friends.find(f=>f.id===d.id)) { db.friends.push({id:d.id, name:d.name}); saveData(); toast(d.name+" acept√≥!"); }
            }
        });
    }

    // --- FRIENDS ---
    function sendFriendRequest() { conn.send({type:'req_friend', id:peer.id, name:db.name}); toast("Enviado"); document.getElementById('btn-add-friend').style.display='none'; }
    function acceptFriend() {
        if(!db.friends.find(f=>f.id===state.pendingFriend.id)) { db.friends.push(state.pendingFriend); saveData(); }
        conn.send({type:'acc_friend', id:peer.id, name:db.name});
        document.getElementById('modal-friend').style.display='none';
    }
    function renderFriends() {
        const c = document.getElementById('friend-list-container'); c.innerHTML='';
        if(db.friends.length===0) c.innerHTML='<p style="text-align:center; color:#666">Sin amigos</p>';
        db.friends.forEach(f => {
            const d = document.createElement('div'); d.className='friend-item';
            d.innerHTML=`<div style="padding:10px; background:#111; margin-bottom:5px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                <b>${f.name}</b> <button class="btn-glass" style="width:auto; padding:5px 10px;" onclick="connectToPeer('${f.id}')">JUGAR</button>
            </div>`;
            c.appendChild(d);
        });
    }

    // --- GAME ---
    function startGame(mode) {
        state.mode = mode; state.myG = 0; state.opG = 0; state.rematchMe=false; state.rematchOp=false; state.usedQ = [];
        
        if(mode !== 'online') state.rival = {id:null, name:'BOT'};
        if(mode === 'libertadores') { state.libRound = 1; document.getElementById('rival-name').innerText = "OCTAVOS"; }
        else if(mode === 'survival') { state.survScore = 0; document.getElementById('rival-name').innerText = "SURVIVAL"; }
        else document.getElementById('rival-name').innerText = state.rival.name;

        // Historial
        if(state.rival.id) {
            const h = db.history[state.rival.id] || {w:0, l:0};
            document.getElementById('hist-disp').innerText = `HISTORIAL: ${h.w} - ${h.l}`;
        } else document.getElementById('hist-disp').innerText = "";

        document.getElementById('modal-end').style.display = 'none';
        setScreen('screen-game');
        updateScore();
        nextQ();
    }

    function nextQ() {
        clearInterval(state.timer);
        state.timeLeft = 20;
        startTimer();

        let available = DB.filter(q => !state.usedQ.includes(q.id));
        if(available.length===0) { state.usedQ=[]; available=DB; }
        const q = available[Math.floor(Math.random()*available.length)];
        state.usedQ.push(q.id);

        document.getElementById('q-text').innerText = q.q;
        const area = document.getElementById('options-area'); area.innerHTML = '';
        
        let idx = [0,1,2,3].sort(()=>Math.random()-0.5);
        idx.forEach(i => {
            const btn = document.createElement('button'); btn.className='opt-btn';
            btn.innerText = q.a[i]; btn.dataset.correct = (i === q.c);
            btn.onclick = () => answer(i === q.c);
            area.appendChild(btn);
        });
    }

    function startTimer() {
        const b = document.getElementById('timer-bar'); b.className='timer-fill';
        state.timer = setInterval(()=>{
            state.timeLeft--; b.style.width=(state.timeLeft/20*100)+'%';
            if(state.timeLeft<=0) { clearInterval(state.timer); punish(); }
        }, 1000);
    }

    function answer(ok) {
        clearInterval(state.timer);
        if(ok) {
            state.myG++; toast("¬°GOL!"); db.coins+=5;
            if(state.mode==='online' && conn) conn.send({type:'goal'});
            if(state.mode==='survival') { state.survScore++; setTimeout(nextQ,1000); return; }
        } else {
            toast("¬°FALLASTE!");
            if(state.mode==='survival') { gameOver(false); return; }
            punish(); return; 
        }
        saveData(); updateScore(); checkEnd();
        if(!isEnd()) setTimeout(nextQ, 1000);
    }

    function punish() {
        if(state.myG>0) state.myG--; else state.opG++;
        updateScore(); checkEnd();
        if(!isEnd()) setTimeout(nextQ, 1000);
    }

    function handleOpGoal() { state.opG++; updateScore(); checkEnd(); }

    function updateScore() {
        drawDots(state.myG, 'dots-me'); drawDots(state.opG, 'dots-op');
    }
    function drawDots(n, id) {
        const el = document.getElementById(id); el.innerHTML='';
        for(let i=0;i<10;i++) el.innerHTML += `<div class="dot ${i<n?'active':''}"></div>`;
    }

    function isEnd() { return state.myG>=10 || state.opG>=10; }
    function checkEnd() { if(state.myG>=10) gameOver(true); else if(state.opG>=10) gameOver(false); }

    function gameOver(win) {
        clearInterval(state.timer);
        const m = document.getElementById('modal-end'); m.style.display='flex';
        document.getElementById('end-title').innerText = win ? "VICTORIA" : "DERROTA";
        document.getElementById('end-msg').innerText = win ? "+50 Monedas" : "Sigue intentando";
        
        if(win) db.coins += 50;
        if(state.rival.id) {
            if(!db.history[state.rival.id]) db.history[state.rival.id] = {w:0, l:0};
            if(win) db.history[state.rival.id].w++; else db.history[state.rival.id].l++;
        }
        saveData();
    }

    // --- REVANCHA / TAUNTS / ITEMS ---
    function reqRematch() {
        state.rematchMe=true; document.getElementById('rematch-status').style.display='block';
        if(state.mode==='bot') setTimeout(()=>startGame('bot'), 1500);
        else if(conn) conn.send({type:'rematch'});
        checkRematch();
    }
    function checkRematch() { if(state.rematchMe && state.rematchOp) startGame('online'); }
    
    function sendTaunt(e) { if(conn) conn.send({type:'taunt', emoji:e}); showTaunt(e); }
    function showTaunt(e) {
        const d = document.createElement('div'); d.innerText=e; d.className='floating-taunt';
        document.getElementById('taunt-layer').appendChild(d);
        setTimeout(()=>d.remove(), 2000);
    }

    function buyItem(t,c){ if(db.coins>=c){db.coins-=c; db.items[t]++; saveData(); toast("COMPRADO");} else toast("Falta dinero"); }
    function useItem(t) {
        if(db.items[t]>0){
            db.items[t]--; saveData(); updateUI();
            const btns = document.querySelectorAll('.opt-btn');
            if(t==='var') { let h=0; btns.forEach(b=>{ if(b.dataset.correct==='false' && h<2){b.disabled=true; b.style.opacity=0.2; h++} }); }
            if(t==='hint') btns.forEach(b=>{ if(b.dataset.correct==='true') b.classList.add('hint'); });
            if(t==='time') { clearInterval(state.timer); state.timeLeft=20; startTimer(); }
        } else toast("Sin items");
    }

    function startLibertadores() { startGame('libertadores'); /* Simplified for robustness */ }
    function startSurvival() { startGame('survival'); }
    function quitGame() { clearInterval(state.timer); setScreen('screen-menu'); document.getElementById('modal-end').style.display='none'; }

</script>
</body>
</html>