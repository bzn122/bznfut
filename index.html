<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bzn Fut | Champions Edition v15</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --accent: #00f2ff; --bg: #050507; --card-bg: rgba(20, 20, 25, 0.95);
            --border: rgba(255, 255, 255, 0.15); --text: #ffffff;
            --success: #10b981; --danger: #ef4444; --gold: #fbbf24;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Rajdhani', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            background-color: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; overflow: hidden;
            background: radial-gradient(circle at 50% 0%, #1e1b4b, #000);
        }

        #app { width: 100%; max-width: 480px; height: 100%; display: flex; flex-direction: column; position: relative; padding: 15px; }

        /* ANIMATIONS */
        .screen { display: none; flex-direction: column; height: 100%; animation: fade 0.3s ease-out; }
        .screen.active { display: flex; }
        @keyframes fade { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        /* UI ELEMENTS */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.4); border-radius: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        
        .btn { width: 100%; padding: 16px; border-radius: 14px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; color: white; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(90deg, var(--primary), #4f46e5); box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }
        .btn-glass { background: rgba(255,255,255,0.08); border: 1px solid var(--border); }
        .btn-libertadores { background: linear-gradient(90deg, #f59e0b, #b45309); color: black; font-weight: 900; }
        .btn-survival { background: linear-gradient(90deg, #ef4444, #991b1b); }

        /* GAMEPLAY UI */
        .scoreboard { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 10px; border-radius: 16px; border: 1px solid #333; margin-bottom: 10px; }
        .score-box { text-align: center; width: 45%; }
        .dots-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 3px; }
        .dot { width: 8px; height: 8px; background: #222; border-radius: 50%; transition: 0.3s; }
        .dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); transform: scale(1.2); }

        .timer-bar { width: 100%; height: 4px; background: #222; margin-bottom: 10px; }
        .timer-fill { height: 100%; background: var(--primary); transition: width 0.2s linear; }
        .timer-fill.danger { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

        .q-box { min-height: 100px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 1.1rem; font-weight: 700; padding: 10px; line-height: 1.3; }
        .opt-btn { width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: #ddd; text-align: left; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; }
        .opt-btn:active { background: var(--accent); color: #000; }

        /* TAUNTS & ITEMS */
        .taunt-bar { display: flex; gap: 5px; margin-bottom: 10px; justify-content: center; }
        .taunt-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #444; background: #111; font-size: 1.2rem; cursor: pointer; }
        .taunt-btn:active { transform: scale(0.9); border-color: var(--accent); }

        .items-dock { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding-top: 10px; border-top: 1px solid var(--border); }
        .item-btn { background: #111; border: 1px solid #333; border-radius: 10px; padding: 8px; text-align: center; font-size: 0.7rem; position: relative; color: #888; }
        .item-btn b { display: block; color: var(--gold); font-size: 0.9rem; margin-top: 2px; }

        /* PENALTY MINIGAME MODAL */
        .penalty-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 500; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .penalty-track { width: 90%; height: 30px; background: #333; border-radius: 15px; position: relative; overflow: hidden; border: 2px solid #555; }
        .penalty-zone { width: 20%; height: 100%; background: var(--success); position: absolute; left: 40%; }
        .penalty-cursor { width: 10px; height: 100%; background: white; position: absolute; left: 0; box-shadow: 0 0 10px white; }
        .penalty-msg { font-size: 2rem; font-weight: 900; margin-bottom: 20px; color: var(--accent); text-transform: uppercase; }

        /* HEATMAP & STATS */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; }
        .progress-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 3px; }

        /* WEATHER EFFECTS */
        #weather-layer { position: absolute; inset: 0; pointer-events: none; z-index: 50; display: none; background: rgba(0,0,0,0.3); }
        .rain { background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII='); background-size: 2px 20px; animation: rain 0.5s linear infinite; opacity: 0.3; }
        @keyframes rain { 0% {background-position: 0 0;} 100% {background-position: 5px 20px;} }

        /* TOAST */
        #toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 8px 24px; border-radius: 30px; font-weight: 800; z-index: 600; box-shadow: 0 0 15px var(--accent); display: none; }
    </style>
</head>
<body>

<div id="toast">MSG</div>
<div id="weather-layer"></div>

<div id="app">
    <!-- MENU -->
    <div id="screen-menu" class="screen active">
        <div class="top-bar">
            <div><span id="u-name" style="font-weight:bold;">Jugador</span></div>
            <div style="color:var(--gold);">ü™ô <span id="u-coins">0</span></div>
        </div>
        <div class="card" style="text-align:center;">
            <h1 style="font-size:2.5rem; color:var(--text); letter-spacing:-1px;">BZN FUT</h1>
            <small style="color:var(--accent); letter-spacing:2px;">CHAMPIONS v15</small>
        </div>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <button class="btn btn-primary" onclick="goToOnline()">‚öîÔ∏è ONLINE HUB</button>
            <button class="btn btn-libertadores" onclick="startLibertadores()">üèÜ LIBERTADORES</button>
            <button class="btn btn-survival" onclick="startSurvival()">üíÄ SURVIVAL</button>
            <button class="btn btn-glass" onclick="startGame('bot')">ü§ñ VS BOT</button>
            <button class="btn btn-glass" onclick="setScreen('screen-profile')">üìä PERFIL Y STATS</button>
            <button class="btn btn-glass" onclick="setScreen('screen-shop')">üõí MERCADO</button>
        </div>
    </div>

    <!-- ONLINE -->
    <div id="screen-online" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ MENU</span> <span>ONLINE</span></div>
        <div class="card">
            <button class="btn btn-primary" onclick="createRoom()">üìù CREAR SALA</button>
            <button class="btn btn-glass" onclick="setScreen('screen-join')">üöÄ UNIRSE</button>
        </div>
        <h4 style="color:#666; margin:10px 0;">AMIGOS</h4>
        <div id="friend-list-container" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- HOST/JOIN -->
    <div id="screen-host" class="screen" style="text-align:center; justify-content:center;">
        <h3 style="color:#888;">TU SALA</h3>
        <h1 id="host-id-disp" style="font-size:3rem; color:var(--accent); margin:20px 0;">...</h1>
        <button class="btn btn-glass" onclick="location.reload()">CANCELAR</button>
    </div>

    <div id="screen-join" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-online')">‚Äπ VOLVER</span></div>
        <div class="card">
            <input id="join-input" style="width:100%; padding:20px; background:#000; border:1px solid #333; color:white; font-size:1.5rem; text-align:center; border-radius:12px;" placeholder="ID SALA">
            <button class="btn btn-primary" style="margin-top:10px;" onclick="connectToPeer()">CONECTAR</button>
        </div>
    </div>

    <!-- JUEGO -->
    <div id="screen-game" class="screen">
        <div class="top-bar">
            <span id="game-mode-display">1VS1</span>
            <div id="event-indicator" style="color:var(--danger); font-weight:bold; display:none;">‚ö†Ô∏è EVENTO</div>
        </div>

        <div class="scoreboard">
            <div class="score-box">
                <span class="p-name">YO</span>
                <div class="dots-row" id="dots-me"></div>
            </div>
            <div style="font-weight:900;">VS</div>
            <div class="score-box">
                <span class="p-name" id="rival-name">RIVAL</span>
                <div class="dots-row" id="dots-op"></div>
            </div>
        </div>

        <div class="timer-bar"><div class="timer-fill" id="timer-bar"></div></div>

        <div class="taunt-bar">
            <button class="taunt-btn" onclick="sendTaunt('whistle')">üòó</button>
            <button class="taunt-btn" onclick="sendTaunt('boo')">üëé</button>
            <button class="taunt-btn" onclick="sendTaunt('goal')">‚öΩ</button>
            <button class="taunt-btn" onclick="sendTaunt('clown')">ü§°</button>
        </div>

        <div class="card q-box" id="q-text">...</div>
        <div id="options-area" style="display:flex; flex-direction:column;"></div>

        <div class="items-dock">
            <div class="item-btn" onclick="useItem('var')">üì∫ VAR <b id="b-var">0</b></div>
            <div class="item-btn" onclick="useItem('hint')">üì£ HINCHADA <b id="b-hint">0</b></div>
            <div class="item-btn" onclick="useItem('time')">‚è≥ EXTRA <b id="b-time">0</b></div>
        </div>
    </div>

    <!-- PERFIL / STATS -->
    <div id="screen-profile" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ VOLVER</span></div>
        <div class="card">
            <h3>HEATMAP (Rendimiento)</h3>
            <div style="margin-top:15px;">
                <div class="stat-row"><span>ARGENTINA</span> <span id="stat-arg-txt">0%</span></div>
                <div class="progress-bg"><div class="progress-fill" id="stat-arg-bar" style="width:0%"></div></div>
            </div>
            <div style="margin-top:15px;">
                <div class="stat-row"><span>MUNDIAL</span> <span id="stat-world-txt">0%</span></div>
                <div class="progress-bg"><div class="progress-fill" id="stat-world-bar" style="width:0%"></div></div>
            </div>
            <div style="margin-top:15px;">
                <div class="stat-row"><span>SURVIVAL RECORD</span> <span id="stat-surv" style="color:var(--gold)">0</span></div>
            </div>
        </div>
        <div class="card">
            <p>NOMBRE</p>
            <input id="inp-name" style="width:100%; padding:10px; background:#000; border:1px solid #333; color:white;" onchange="saveData()">
            <button class="btn btn-glass" style="margin-top:10px;" onclick="resetData()">BORRAR DATOS</button>
        </div>
    </div>

    <!-- TIENDA -->
    <div id="screen-shop" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ VOLVER</span></div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; padding:10px;">
                <span>üì∫ VAR</span> <button class="btn btn-glass" style="width:auto; padding:5px 15px;" onclick="buyItem('var', 50)">$50</button>
            </div>
            <div style="display:flex; justify-content:space-between; padding:10px;">
                <span>üì£ HINCHADA</span> <button class="btn btn-glass" style="width:auto; padding:5px 15px;" onclick="buyItem('hint', 40)">$40</button>
            </div>
            <div style="display:flex; justify-content:space-between; padding:10px;">
                <span>‚è≥ EXTRA</span> <button class="btn btn-glass" style="width:auto; padding:5px 15px;" onclick="buyItem('time', 30)">$30</button>
            </div>
        </div>
    </div>

    <!-- PENALTY MINIGAME -->
    <div id="modal-penalty" class="penalty-modal">
        <div class="penalty-msg">¬°PENAL!</div>
        <div class="penalty-track">
            <div class="penalty-zone"></div>
            <div class="penalty-cursor" id="p-cursor"></div>
        </div>
        <p style="color:#aaa; margin-top:20px;">Toca para patear</p>
        <button class="btn btn-primary" style="margin-top:20px; width:200px;" onmousedown="shootPenalty()" ontouchstart="shootPenalty()">PATEAR</button>
    </div>

    <!-- FIN MODAL -->
    <div id="modal-end" class="penalty-modal" style="background:rgba(0,0,0,0.95);">
        <h1 id="end-title" style="font-size:3rem; margin-bottom:10px;">FIN</h1>
        <p id="end-msg" style="color:#888;">...</p>
        <button class="btn btn-primary" style="margin-top:20px;" onclick="quitGame()">CONTINUAR</button>
    </div>

</div>

<script>
    // --- DATABASE (Cat: 1=Arg, 2=World) ---
    const DB = [
        {c:1, q:"¬øClub actual de Juli√°n √Ålvarez?", a:["Atl√©tico Madrid", "Man. City", "River", "Barcelona"], ok:0},
        {c:2, q:"¬øClub actual de Mbapp√©?", a:["Real Madrid", "PSG", "Monaco", "Liverpool"], ok:0},
        {c:1, q:"¬øCampe√≥n Libertadores 2024?", a:["Botafogo", "Atl. Mineiro", "River", "Flamengo"], ok:0},
        {c:2, q:"¬øCampe√≥n Eurocopa 2024?", a:["Espa√±a", "Inglaterra", "Francia", "Alemania"], ok:0},
        {c:1, q:"¬øQui√©n es el Dibu?", a:["Mart√≠nez", "Armani", "Romero", "Andrada"], ok:0},
        {c:1, q:"¬øEstadio de Boca Juniors?", a:["Bombonera", "Monumental", "Cilindro", "Quemero"], ok:0},
        {c:2, q:"¬øM√°ximo ganador de Champions?", a:["Real Madrid", "Milan", "Bayern", "Liverpool"], ok:0},
        {c:1, q:"¬øApodo de River Plate?", a:["Millonario", "Xeneize", "Canalla", "Lobo"], ok:0},
        {c:2, q:"¬øD√≥nde juega Haaland?", a:["Man. City", "Dortmund", "Leeds", "Bayern"], ok:0},
        {c:1, q:"¬øDT de Argentina 2024?", a:["Scaloni", "Bielsa", "Sampaoli", "Martino"], ok:0}
    ];

    // --- STATE ---
    let db = JSON.parse(localStorage.getItem('bzn_fut_v15')) || {
        name: 'Jugador', coins: 100, items: {var:3, hint:3, time:3}, friends: [],
        stats: {arg:{ok:0, t:0}, world:{ok:0, t:0}, surv:0}
    };

    let state = {
        mode: null, myG:0, opG:0, timer:null, timeLeft:20, 
        penAnim:null, penDir:1, penPos:0,
        libRound:0, survScore:0, opStreak:0
    };
    let peer, conn, audioCtx;

    // --- INIT ---
    window.onload = () => {
        updateUI();
        setScreen('screen-menu');
    };

    function setScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='screen-online') renderFriends();
    }

    function updateUI() {
        document.getElementById('u-name').innerText = db.name;
        document.getElementById('u-coins').innerText = db.coins;
        document.getElementById('b-var').innerText = db.items.var;
        document.getElementById('b-hint').innerText = db.items.hint;
        document.getElementById('b-time').innerText = db.items.time;
        document.getElementById('inp-name').value = db.name;
        
        // Heatmap Calc
        const calc = (s) => s.t===0 ? 0 : Math.round((s.ok/s.t)*100);
        const pA = calc(db.stats.arg);
        const pW = calc(db.stats.world);
        document.getElementById('stat-arg-txt').innerText = pA + '%';
        document.getElementById('stat-arg-bar').style.width = pA + '%';
        document.getElementById('stat-world-txt').innerText = pW + '%';
        document.getElementById('stat-world-bar').style.width = pW + '%';
        document.getElementById('stat-surv').innerText = db.stats.surv;
    }

    function saveData() { 
        db.name = document.getElementById('inp-name').value;
        localStorage.setItem('bzn_fut_v15', JSON.stringify(db)); 
        updateUI(); 
    }
    
    function resetData() { localStorage.removeItem('bzn_fut_v15'); location.reload(); }

    function toast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none', 1500);
    }

    // --- MODES ---
    function startGame(mode) {
        state.mode = mode; state.myG = 0; state.opG = 0; state.opStreak = 0;
        document.getElementById('game-mode-display').innerText = mode.toUpperCase();
        document.getElementById('event-indicator').style.display = 'none';
        document.getElementById('weather-layer').style.display = 'none';

        if(mode === 'survival') state.survScore = 0;
        if(mode === 'libertadores') state.libRound = 0;

        setScreen('screen-game');
        updateScore();
        nextQ();
    }

    function startSurvival() { startGame('survival'); }
    
    function startLibertadores() {
        state.libRound = 1; // 1:Oct, 2:Cuartos, 3:Semi, 4:Final
        state.mode = 'libertadores';
        state.myG = 0; state.opG = 0;
        document.getElementById('game-mode-display').innerText = "OCTAVOS DE FINAL";
        setScreen('screen-game');
        updateScore();
        nextQ();
    }

    function nextQ() {
        clearInterval(state.timer);
        state.timeLeft = 20;
        
        // Event Check (Anti-Streak)
        if(state.opStreak >= 3) triggerEvent();
        else {
            document.getElementById('event-indicator').style.display = 'none';
            document.getElementById('weather-layer').style.display = 'none';
        }

        startTimer();

        const q = DB[Math.floor(Math.random()*DB.length)];
        // Track stats cat
        state.currQCat = q.c; 

        document.getElementById('q-text').innerText = q.q;
        const area = document.getElementById('options-area'); area.innerHTML = '';
        
        let idx = [0,1,2,3].sort(()=>Math.random()-0.5);
        idx.forEach(i => {
            const b = document.createElement('button'); b.className = 'opt-btn';
            b.innerText = q.a[i]; b.dataset.correct = (i === q.ok);
            b.onclick = () => answer(i === q.ok);
            area.appendChild(b);
        });
    }

    function triggerEvent() {
        state.opStreak = 0;
        const type = Math.random();
        if(type < 0.33) {
            toast("¬°LLUVIA TORRENCIAL!");
            document.getElementById('weather-layer').className = 'rain';
            document.getElementById('weather-layer').style.display = 'block';
        } else if(type < 0.66) {
            toast("¬°VIENTO EN CONTRA! (-Tiempo)");
            state.timeLeft = 10;
        } else {
            toast("¬°PRESI√ìN HINCHADA!");
            document.getElementById('app').style.animation = 'shake 0.5s';
            setTimeout(()=>document.getElementById('app').style.animation='', 500);
        }
        document.getElementById('event-indicator').style.display = 'block';
    }

    function startTimer() {
        const b = document.getElementById('timer-bar'); b.className='timer-fill';
        state.timer = setInterval(() => {
            state.timeLeft--;
            b.style.width = (state.timeLeft/20*100)+'%';
            if(state.timeLeft<=0) { clearInterval(state.timer); punish(); }
        }, 1000);
    }

    function answer(ok) {
        clearInterval(state.timer);
        // Stats
        if(state.currQCat === 1) { db.stats.arg.t++; if(ok) db.stats.arg.ok++; }
        if(state.currQCat === 2) { db.stats.world.t++; if(ok) db.stats.world.ok++; }
        saveData();

        if(ok) {
            if(state.mode === 'survival') {
                state.survScore++;
                toast("¬°BIEN! SCORE: " + state.survScore);
                setTimeout(nextQ, 1000);
            } else {
                openPenalty(); // MINIGAME TRIGGER
            }
        } else {
            if(state.mode === 'survival') {
                gameOver(false);
            } else {
                punish();
            }
        }
    }

    // --- PENALTY MINIGAME ---
    function openPenalty() {
        document.getElementById('modal-penalty').style.display = 'flex';
        state.penPos = 0; state.penDir = 1;
        
        // Animation Loop
        const loop = () => {
            state.penPos += (2 * state.penDir); // Speed
            if(state.penPos > 90) state.penDir = -1;
            if(state.penPos < 0) state.penDir = 1;
            document.getElementById('p-cursor').style.left = state.penPos + '%';
            state.penAnim = requestAnimationFrame(loop);
        };
        loop();
    }

    function shootPenalty() {
        cancelAnimationFrame(state.penAnim);
        document.getElementById('modal-penalty').style.display = 'none';
        
        // Zone check (40% to 60% is green)
        if(state.penPos >= 40 && state.penPos <= 60) {
            state.myG++;
            toast("¬°GOLAZO!");
            if(state.mode === 'online' && conn) conn.send({type:'goal'});
        } else {
            toast("¬°LA TIRASTE AFUERA!");
        }
        updateScore();
        checkEnd();
    }

    function punish() {
        toast("FALLASTE");
        if(state.myG > 0) state.myG--; else state.opG++;
        
        // Bot Logic: Bot might streak
        if(state.mode !== 'online') {
            if(Math.random() > 0.5) state.opStreak++; else state.opStreak=0;
        }

        updateScore();
        checkEnd();
    }

    function updateScore() {
        drawDots(state.myG, 'dots-me'); drawDots(state.opG, 'dots-op');
        if(!isEnd() && document.getElementById('modal-penalty').style.display === 'none') setTimeout(nextQ, 1000);
    }
    
    function drawDots(n, id) {
        const el = document.getElementById(id); el.innerHTML='';
        for(let i=0;i<5;i++) el.innerHTML += `<div class="dot ${i<n?'active':''}"></div>`;
    }
    
    function isEnd() { return state.myG>=5 || state.opG>=5; }

    function checkEnd() {
        if(state.myG>=5) gameOver(true); else if(state.opG>=5) gameOver(false);
    }

    function gameOver(win) {
        if(state.mode === 'survival') {
             // Save record
             if(state.survScore > db.stats.surv) db.stats.surv = state.survScore;
             showEndModal("GAME OVER", "R√©cord: " + state.survScore);
             return;
        }

        if(state.mode === 'libertadores') {
            if(win) {
                state.libRound++;
                if(state.libRound > 4) { showEndModal("¬°CAMPE√ìN DE AM√âRICA!", "La Gloria Eterna"); state.libRound=0; }
                else {
                    let rNames = ["", "OCTAVOS", "CUARTOS", "SEMIFINAL", "FINAL"];
                    alert("GANASTE! PASAS A " + rNames[state.libRound]);
                    state.myG=0; state.opG=0;
                    document.getElementById('game-mode-display').innerText = rNames[state.libRound];
                    updateScore();
                    nextQ();
                }
            } else {
                showEndModal("ELIMINADO", "Vuelve a intentar");
            }
            return;
        }

        showEndModal(win ? "VICTORIA" : "DERROTA", win ? "+50 Monedas" : "Sigue entrenando");
        if(win) db.coins += 50;
        saveData();
    }

    function showEndModal(t, m) {
        document.getElementById('modal-end').style.display = 'flex';
        document.getElementById('end-title').innerText = t;
        document.getElementById('end-msg').innerText = m;
    }

    function quitGame() {
        clearInterval(state.timer);
        document.getElementById('modal-end').style.display = 'none';
        setScreen('screen-menu');
    }

    // --- AUDIO / TAUNTS ---
    function sendTaunt(t) {
        // Local sound
        playSound(t);
        // Send
        if(state.mode === 'online' && conn) conn.send({type:'taunt', s:t});
    }

    function playSound(type) {
        if(!window.AudioContext) return;
        if(!audioCtx) audioCtx = new window.AudioContext();
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.connect(g); g.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;
        if(type==='whistle') { osc.frequency.setValueAtTime(3000, now); osc.frequency.linearRampToValueAtTime(2000, now+0.1); osc.start(); osc.stop(now+0.5); }
        if(type==='boo') { osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now+1); osc.start(); osc.stop(now+1); }
        if(type==='goal') { osc.type='square'; osc.frequency.setValueAtTime(400, now); osc.frequency.setValueAtTime(600, now+0.2); osc.start(); osc.stop(now+0.6); }
        if(type==='clown') { osc.type='triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(100, now+0.3); osc.start(); osc.stop(now+0.3); }
    }

    // --- ONLINE & ITEMS ---
    function goToOnline() { setScreen('screen-online'); renderFriends(); }
    function createRoom() { setScreen('screen-host'); const c='BZN-'+Math.floor(Math.random()*9999); document.getElementById('host-id-disp').innerText=c; peer=new Peer(c); peer.on('connection', c=>{conn=c; setupConn();}); }
    function connectToPeer() { const id=document.getElementById('join-input').value; if(!id)return; peer=new Peer(); peer.on('open', ()=>{conn=peer.connect(id); setupConn();}); }
    
    function setupConn() {
        conn.on('open', ()=>{conn.send({type:'hello', name:db.name});});
        conn.on('data', d=>{
            if(d.type==='hello') { state.rival={name:d.name}; startGame('online'); }
            if(d.type==='goal') handleOpGoal();
            if(d.type==='taunt') { toast("RIVAL: " + d.s); playSound(d.s); }
        });
    }

    function renderFriends() { /* Placeholder for friend logic from prev versions */ }
    
    function buyItem(t,c) { if(db.coins>=c){db.coins-=c; db.items[t]++; saveData(); toast("COMPRADO");} else toast("FALTA DINERO"); }
    function useItem(t) { if(db.items[t]>0){ db.items[t]--; saveData(); updateUI(); if(t==='time') {clearInterval(state.timer); state.timeLeft=20; startTimer();} else toast("USADO"); } }

</script>
</body>
</html>