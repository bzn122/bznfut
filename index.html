<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AFA EVO v12 | Ultimate League</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --neon: #00f2ff; --bg: #050505; --surface: #101216; --text: #fff;
            --gold: #ffd700; --danger: #ff0040; --success: #00ff80;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; overflow: hidden; }
        
        #app { width: 100%; max-width: 480px; height: 100%; display: flex; flex-direction: column; padding: 15px; background: radial-gradient(circle at top, #0a1520, #000); position: relative; }

        .screen { display: none; flex-direction: column; height: 100%; animation: fade 0.3s ease; }
        .screen.active { display: flex; }
        @keyframes fade { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        /* HEADER & STATS */
        .top-bar { display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 10px; align-items: center; border: 1px solid #222; }
        .stat-pill { display: flex; align-items: center; font-weight: bold; font-size: 0.8rem; gap: 5px; }
        .coin-icon { width: 16px; height: 16px; background: var(--gold); border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 5px var(--gold); }

        /* MENU */
        .menu-grid { display: flex; flex-direction: column; gap: 10px; margin: auto 0; }
        .menu-btn {
            background: linear-gradient(90deg, #111, #1a1a1a);
            border: 1px solid #333; padding: 18px; border-radius: 12px;
            color: white; font-size: 1rem; font-weight: 600;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.1s; position: relative; overflow: hidden;
        }
        .menu-btn:active { background: var(--neon); color: #000; transform: scale(0.98); }
        .btn-green { border-color: var(--success); color: var(--success); }
        .btn-green:active { background: var(--success); color: #000; }

        /* GAME UI */
        .match-history { text-align: center; font-size: 0.7rem; color: #888; margin-bottom: 5px; letter-spacing: 1px; }
        .scoreboard { display: flex; justify-content: space-between; margin-bottom: 5px; background: #080808; padding: 10px; border-radius: 12px; border: 1px solid #222; }
        .p-score { text-align: center; width: 48%; }
        .p-name { font-size: 0.7rem; color: #aaa; margin-bottom: 4px; display: block; }
        
        .goals-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; justify-items: center; } 
        /* Ajuste para 10 goles: 2 filas de 5 o 1 de 10 peque√±a. Hagamos 1 fila flex wrap si es necesario, o grid */
        .goals-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 2px; }
        
        .ball { width: 8px; height: 8px; border-radius: 50%; background: #222; border: 1px solid #444; transition: 0.3s; margin: 1px; }
        .ball.active { background: #fff; box-shadow: 0 0 5px #fff; border-color: #fff; transform: scale(1.2); }

        /* TIMER */
        .timer-container { width: 100%; height: 4px; background: #222; margin-bottom: 15px; border-radius: 2px; overflow: hidden; }
        .timer-bar { height: 100%; width: 100%; background: var(--neon); transition: width 1s linear; box-shadow: 0 0 5px var(--neon); }
        .timer-bar.danger { background: var(--danger); box-shadow: 0 0 5px var(--danger); }

        .q-card { background: #111; padding: 15px; border-radius: 16px; text-align: center; margin-bottom: 15px; border: 1px solid #222; min-height: 100px; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: bold; }
        .opt-btn { width: 100%; padding: 14px; margin-bottom: 8px; background: #161616; border: 1px solid #2a2a2a; border-radius: 10px; color: #ccc; font-weight: 500; text-align: left; transition: 0.1s; position: relative; }
        .opt-btn:disabled { opacity: 0.2; cursor: not-allowed; background: #000; border-color: #111; }
        .opt-btn.correct-hint { border: 2px solid var(--success); background: rgba(0, 255, 128, 0.1); color: var(--success); }

        /* ITEMS BAR */
        .items-bar { display: flex; gap: 10px; margin-top: auto; justify-content: center; padding-top: 10px; border-top: 1px solid #222; }
        .item-btn { background: #111; border: 1px solid #333; padding: 10px; border-radius: 10px; width: 32%; text-align: center; font-size: 0.7rem; color: #888; position: relative; }
        .item-btn.active { color: white; border-color: var(--neon); }
        .item-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }

        /* MODAL REVANCHA */
        #rematch-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; padding: 20px; text-align: center; }

        /* FRIEND LIST */
        .friend-list { margin-top: 20px; border-top: 1px solid #333; padding-top: 10px; max-height: 200px; overflow-y: auto; }
        .friend-item { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 10px; border-radius: 8px; margin-bottom: 5px; border: 1px solid #222; }
        .friend-status { width: 10px; height: 10px; border-radius: 50%; background: #444; margin-right: 10px; }
        .friend-status.online { background: var(--success); box-shadow: 0 0 5px var(--success); }

        #toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(0, 242, 255, 0.9); color: #000; padding: 8px 20px; border-radius: 20px; font-weight: 800; z-index: 999; display: none; pointer-events: none; width: 80%; text-align: center; }
        
        .id-display { font-family: monospace; font-size: 1.2rem; color: var(--neon); margin: 15px 0; background: #000; padding: 10px; border-radius: 10px; border: 1px dashed #333; text-align: center; word-break: break-all; }
        .input-box { width: 100%; padding: 15px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; margin-bottom: 10px; text-align: center; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="toast">GOL</div>

    <div id="app">
        <!-- HEADER -->
        <div class="top-bar">
            <div class="stat-pill"><div class="coin-icon"></div> <span id="ui-cash">0</span></div>
            <div class="stat-pill" style="color: var(--neon);" id="ui-div">DIV 10</div>
            <div class="stat-pill" onclick="setScreen('screen-settings')">‚öôÔ∏è</div>
        </div>

        <!-- MENU PRINCIPAL -->
        <div id="screen-menu" class="screen active">
            <div style="text-align: center; margin: 30px 0;">
                <h1 style="font-size: 2.5rem; font-style: italic;">AFA <span style="color:var(--neon)">EVO</span></h1>
                <small style="color: #666; letter-spacing: 2px;">V12 ULTIMATE LEAGUE</small>
            </div>
            
            <div class="menu-grid">
                <div class="menu-btn" onclick="startGame('career')"><span>üèÜ MODO CARRERA</span> <small>OFFLINE</small></div>
                <div class="menu-btn" onclick="setScreen('screen-online-menu')"><span>‚öîÔ∏è ONLINE REAL</span> <small>P2P</small></div>
                <div class="menu-btn" onclick="startGame('bot')"><span>ü§ñ VS BOT</span> <small>R√ÅPIDO</small></div>
                <div class="menu-btn" onclick="setScreen('screen-shop')"><span>üõí MERCADO</span></div>
            </div>
        </div>

        <!-- ONLINE MENU -->
        <div id="screen-online-menu" class="screen">
            <h2 style="text-align: center; margin-bottom: 20px;">ONLINE CENTER</h2>
            <div class="menu-grid">
                <div class="menu-btn" onclick="initHost()"><span>üìù CREAR SALA</span></div>
                <div class="menu-btn" onclick="setScreen('screen-join')"><span>üöÄ UNIRSE</span></div>
            </div>

            <div class="friend-list">
                <small style="color:#666; display:block; margin-bottom:10px;">MIS AMIGOS</small>
                <div id="friends-container"></div>
            </div>
            
            <div class="menu-btn" style="background:#111; justify-content:center; margin-top:auto;" onclick="setScreen('screen-menu')">VOLVER</div>
        </div>

        <!-- HOST / JOIN SCREENS -->
        <div id="screen-host" class="screen" style="text-align:center;">
            <h3>TU ID DE SALA</h3>
            <div id="host-id-disp" class="id-display">Generando...</div>
            <p style="color:#666;">Comparte este c√≥digo.</p>
            <button class="menu-btn" style="margin-top:auto; background:#111; justify-content:center;" onclick="location.reload()">CANCELAR</button>
        </div>

        <div id="screen-join" class="screen">
            <h3 style="text-align:center;">UNIRSE</h3>
            <input id="join-input" class="input-box" placeholder="ID DEL RIVAL">
            <div class="menu-btn" style="justify-content:center;" onclick="connectToHost()">CONECTAR</div>
            <div class="menu-btn" style="margin-top:auto; background:#111; justify-content:center;" onclick="setScreen('screen-online-menu')">VOLVER</div>
        </div>

        <!-- JUEGO -->
        <div id="screen-game" class="screen">
            <div class="match-history" id="hist-disp">HISTORIAL: 0 - 0</div>
            
            <div class="scoreboard">
                <div class="p-score">
                    <span class="p-name">YO</span>
                    <div class="goals-container" id="ui-goals-me"></div>
                </div>
                <div style="display: flex; align-items: center; font-weight: bold; color:#444;">VS</div>
                <div class="p-score">
                    <span class="p-name">RIVAL</span>
                    <div class="goals-container" id="ui-goals-op"></div>
                </div>
            </div>

            <div class="timer-container"><div class="timer-bar" id="ui-timer"></div></div>

            <div class="q-card"><span id="q-text">...</span></div>
            <div id="options-area"></div>

            <!-- BOTON AGREGAR AMIGO (Solo en Online y si no es amigo aun) -->
            <div id="add-friend-btn" class="menu-btn btn-green" style="display:none; padding:10px; justify-content:center; margin-bottom:10px;" onclick="addCurrentFriend()">
                + AGREGAR RIVAL A AMIGOS
            </div>

            <div class="items-bar">
                <div class="item-btn" onclick="useItem('var')">
                    <div class="item-badge" id="c-var">0</div> üì∫ VAR
                </div>
                <div class="item-btn" onclick="useItem('hinchada')">
                    <div class="item-badge" id="c-hinchada">0</div> üì£ HINCHADA
                </div>
                <div class="item-btn" onclick="useItem('time')">
                    <div class="item-badge" id="c-time">0</div> ‚è≥ EXTRA
                </div>
            </div>
            
            <div style="margin-top: 10px;">
                <button style="background:none; border:none; color:#444; width:100%; font-size:0.8rem;" onclick="quitGame()">ABANDONAR</button>
            </div>

            <!-- MODAL REVANCHA -->
            <div id="rematch-modal">
                <h2 id="end-title" style="font-size: 2rem; margin-bottom: 10px;">FIN</h2>
                <p id="rematch-status" style="color: var(--neon); margin-bottom: 30px;">Esperando decisi√≥n...</p>
                <div style="width:100%; display:grid; gap:10px;">
                    <div class="menu-btn" style="justify-content:center;" onclick="requestRematch()">üîÑ PEDIR REVANCHA</div>
                    <div class="menu-btn" style="justify-content:center; background:#111;" onclick="quitGame()">‚ùå SALIR</div>
                </div>
            </div>
        </div>

        <!-- TIENDA -->
        <div id="screen-shop" class="screen">
            <h2>MERCADO</h2>
            <div class="menu-grid" style="margin-top: 20px;">
                <div class="menu-btn" onclick="buyItem('var', 50)"><span>üì∫ VAR</span> <span style="color:var(--gold)">$50</span></div>
                <div class="menu-btn" onclick="buyItem('hinchada', 40)"><span>üì£ HINCHADA</span> <span style="color:var(--gold)">$40</span></div>
                <div class="menu-btn" onclick="buyItem('time', 30)"><span>‚è≥ TIEMPO EXTRA</span> <span style="color:var(--gold)">$30</span></div>
                <div class="menu-btn" style="background: #111; justify-content: center;" onclick="setScreen('screen-menu')">VOLVER</div>
            </div>
        </div>
        
        <!-- SETTINGS -->
        <div id="screen-settings" class="screen">
            <h2>OPCIONES</h2>
            <div style="margin-top: 20px;">
                <small style="color:#666">TU NOMBRE</small>
                <input id="set-name" class="input-box" onchange="saveData()" placeholder="Jugador">
                <small style="color:#666">TU ID FIJO (OPCIONAL)</small>
                <input id="set-fixed-id" class="input-box" onchange="saveData()" placeholder="Ej: JUAN-10">
                <div class="menu-btn" style="margin-top:10px;" onclick="toggleSound()"><span>SONIDO</span> <span id="snd-status">ON</span></div>
                <div class="menu-btn" style="margin-top:20px; background:#111; justify-content:center;" onclick="setScreen('screen-menu')">VOLVER</div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let db = JSON.parse(localStorage.getItem('afa_v12')) || { 
            cash: 200, name: 'Jugador', fixedId: '', sound: true, items: {var:2, hinchada:2, time:2},
            friends: [], // [{id, name}]
            history: {} // { 'rivalID': {w:0, l:0} }
        };
        
        let state = { mode: '', myG: 0, opG: 0, diff: 1, timer: null, timeLeft: 20, usedQ: [], currentRivalId: null, currentRivalName: 'BOT', rematchReq: false, opRematch: false };
        let peer, conn, audioCtx;

        // --- DATABASE (ID: Unique, D: Diff 1-3, C: Correct Index) ---
        const DB = [
            {id:1, d:1, q:"¬øQui√©n gan√≥ el Mundial 2022?", a:["Argentina","Francia","Brasil","Croacia"], c:0},
            {id:2, d:1, q:"¬øApodo de Boca Juniors?", a:["Xeneize","Millonario","Rojo","Canalla"], c:0},
            {id:3, d:1, q:"¬øDorsal de Messi?", a:["10","7","9","11"], c:0},
            {id:4, d:1, q:"¬øEstadio de River?", a:["Monumental","Bombonera","Cilindro","Amalfitani"], c:0},
            {id:5, d:1, q:"¬øQui√©n gan√≥ la Champions 2023?", a:["Man. City","Inter","Real Madrid","Milan"], c:0},
            {id:6, d:2, q:"¬øQui√©n gan√≥ la Libertadores 2018?", a:["River","Boca","Gremio","Palmeiras"], c:0},
            {id:7, d:2, q:"¬ø√çdolo de Independiente?", a:["Bochini","Ag√ºero","Bertoni","Burruchaga"], c:0},
            {id:8, d:2, q:"¬øDescenso de River (A√±o)?", a:["2011","2010","2012","2009"], c:0},
            {id:9, d:2, q:"¬øGoleador hist√≥rico de Boca?", a:["Palermo","Riquelme","Tevez","Varallo"], c:0},
            {id:10, d:2, q:"¬øDT de Argentina 2014?", a:["Sabella","Martino","Pekerman","Maradona"], c:0},
            {id:11, d:3, q:"¬øCampe√≥n del Metro 1981?", a:["Boca","River","Ferro","Newell's"], c:0},
            {id:12, d:3, q:"¬øRival Independiente Intercont. 73?", a:["Juventus","Ajax","Milan","Liverpool"], c:0},
            {id:13, d:3, q:"¬øGol de la valija (Autor)?", a:["Gareca","Ruggeri","Burruchaga","Valdano"], c:0},
            {id:14, d:3, q:"¬øGoleador Mundial 86?", a:["Lineker","Maradona","Careca","Butrague√±o"], c:0},
            {id:15, d:3, q:"¬øDT de River 1996?", a:["Ram√≥n D√≠az","Gallego","Passarella","Babington"], c:0},
            {id:16, d:1, q:"¬øColores de San Lorenzo?", a:["Azul y Rojo","Azul y Oro","Rojo y Blanco","Celeste"], c:0},
            {id:17, d:2, q:"¬øApodo de Estudiantes LP?", a:["Pincharrata","Lobo","Taladro","Cervecero"], c:0},
            {id:18, d:3, q:"¬øA√±o fundaci√≥n de Boca?", a:["1905","1901","1903","1910"], c:0},
            {id:19, d:1, q:"¬øSede Mundial 2014?", a:["Brasil","Alemania","Sud√°frica","Rusia"], c:0},
            {id:20, d:2, q:"¬øQui√©n es 'La Brujita'?", a:["Ver√≥n","Ortega","Gallardo","Riquelme"], c:0},
            {id:21, d:3, q:"¬øQui√©n gan√≥ la Supercopa 97?", a:["River","Sao Paulo","Velez","Colo Colo"], c:0},
            {id:22, d:2, q:"¬øArquero de los penales 2014?", a:["Romero","Abbondanzieri","Goycochea","Dibu"], c:0},
            {id:23, d:1, q:"¬øEquipo de Maradona en Italia?", a:["Napoli","Juventus","Milan","Roma"], c:0},
            {id:24, d:2, q:"¬øApodo de Racing Club?", a:["La Academia","El Rojo","El Fort√≠n","El Globo"], c:0},
            {id:25, d:3, q:"¬øQui√©n err√≥ el penal en Italia 90 vs Alemania?", a:["Nadie (No hubo)","Maradona","Troglio","Sensini"], c:0}, 
            {id:26, d:3, q:"¬øGol en la final 86?", a:["Burruchaga","Valdano","Brown","Todos"], c:3}
        ];

        // --- CORE UI ---
        function setScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            updateUI();
            if(id === 'screen-online-menu') renderFriendList();
        }

        function updateUI() {
            document.getElementById('ui-cash').innerText = db.cash;
            document.getElementById('set-name').value = db.name;
            document.getElementById('set-fixed-id').value = db.fixedId || '';
            document.getElementById('snd-status').innerText = db.sound ? "ON" : "OFF";
            document.getElementById('c-var').innerText = db.items.var;
            document.getElementById('c-hinchada').innerText = db.items.hinchada;
            document.getElementById('c-time').innerText = db.items.time;
        }

        function saveData() {
            db.name = document.getElementById('set-name').value;
            db.fixedId = document.getElementById('set-fixed-id').value;
            localStorage.setItem('afa_v12', JSON.stringify(db));
            updateUI();
        }

        function sfx(type) {
            if(!db.sound) return;
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if(type==='win') { osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1200, now+0.1); }
            if(type==='loss') { osc.type='sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+0.3); }
            osc.start(); osc.stop(now+0.3);
        }

        function showToast(m, t) {
            const el = document.getElementById('toast'); el.innerText=m;
            el.style.background = t==='good' ? 'var(--success)' : (t==='bad'?'var(--danger)':'var(--neon)');
            el.style.display='block'; setTimeout(()=>el.style.display='none', 1000);
        }

        // --- FRIEND & HISTORY SYSTEM ---
        function addCurrentFriend() {
            if(!state.currentRivalId) return;
            // 1. Save Locally
            if(!db.friends.find(f => f.id === state.currentRivalId)) {
                db.friends.push({ id: state.currentRivalId, name: state.currentRivalName });
                saveData();
                showToast("AMIGO AGREGADO", "good");
                document.getElementById('add-friend-btn').style.display = 'none';
            }
            // 2. Send Sync Request (Bidirectional)
            if(conn && conn.open) {
                conn.send({ type: 'friend_sync', id: (db.fixedId || peer.id), name: db.name });
            }
        }

        function renderFriendList() {
            const c = document.getElementById('friends-container'); c.innerHTML='';
            if(db.friends.length===0) c.innerHTML='<small style="color:#444">Sin amigos guardados</small>';
            db.friends.forEach(f => {
                const item = document.createElement('div'); item.className='friend-item';
                item.innerHTML=`
                    <div style="display:flex; align-items:center;">
                        <div class="friend-status" id="st-${f.id}"></div>
                        <span style="font-size:0.9rem; font-weight:bold;">${f.name}</span>
                    </div>
                    <button class="menu-btn" style="padding:5px 10px; font-size:0.7rem;" onclick="inviteFriend('${f.id}')">INVITAR</button>
                `;
                c.appendChild(item);
            });
        }

        function inviteFriend(id) {
            showToast("CONECTANDO...", "neutral");
            // If we have a fixed ID, use it, else random
            const myId = db.fixedId || null;
            peer = new Peer(myId);
            peer.on('open', () => {
                conn = peer.connect(id);
                conn.on('open', () => {
                    document.getElementById(`st-${id}`).classList.add('online');
                    showToast("CONECTADO", "good");
                    setupConn("CLIENT");
                });
                setTimeout(() => { if(!conn.open) showToast("NO RESPONDE", "bad"); }, 5000);
            });
        }

        function updateHistoryDisp() {
            const disp = document.getElementById('hist-disp');
            if(!state.currentRivalId || state.mode !== 'online') {
                disp.innerText = "HISTORIAL: 0 - 0";
                return;
            }
            const h = db.history[state.currentRivalId] || {w:0, l:0};
            disp.innerText = `HISTORIAL: ${h.w} G - ${h.l} P`;
        }

        // --- ONLINE LOGIC ---
        function initHost() {
            setScreen('screen-host');
            const code = db.fixedId || ('AFA-' + Math.floor(Math.random()*9999));
            peer = new Peer(code);
            peer.on('open', id => document.getElementById('host-id-disp').innerText = id);
            peer.on('connection', c => { conn=c; setupConn("HOST"); });
        }

        function connectToHost() {
            const id = document.getElementById('join-input').value;
            if(!id) return;
            const myId = db.fixedId || null;
            peer = new Peer(myId);
            peer.on('open', () => { conn = peer.connect(id); setupConn("CLIENT"); });
        }

        function setupConn(role) {
            conn.on('open', () => { conn.send({type:'handshake', name:db.name, id:(db.fixedId||peer.id)}); });
            conn.on('data', d => {
                if(d.type === 'handshake') {
                    state.currentRivalName = d.name;
                    state.currentRivalId = d.id;
                    if(role === 'HOST') conn.send({type:'handshake', name:db.name, id:(db.fixedId||peer.id)});
                    startGame('online');
                }
                if(d.type === 'goal') handleOpponentGoal();
                if(d.type === 'rematch') {
                    state.opRematch = true;
                    if(state.rematchReq) startGame('online');
                    else document.getElementById('rematch-status').innerText = "¬°Rival pide revancha!";
                }
                if(d.type === 'friend_sync') {
                    // Auto-Add Friend logic (Received from other)
                    if(!db.friends.find(f => f.id === d.id)) {
                        db.friends.push({ id: d.id, name: d.name });
                        saveData();
                        showToast(`¬°${d.name} TE AGREG√ì!`, "good");
                    }
                }
            });
        }

        // --- GAME LOOP ---
        function startGame(mode) {
            state.mode = mode;
            state.myG = 0; state.opG = 0; state.diff = 1;
            state.rematchReq = false; state.opRematch = false;
            
            if(mode === 'bot' || mode === 'career') {
                state.currentRivalName = 'BOT';
                state.currentRivalId = null;
            }
            
            document.getElementById('rematch-modal').style.display = 'none';
            setScreen('screen-game');
            updateScoreboard();
            updateHistoryDisp();

            // Friend Button Logic
            const fBtn = document.getElementById('add-friend-btn');
            if(mode === 'online' && state.currentRivalId && !db.friends.find(f => f.id === state.currentRivalId)) {
                fBtn.style.display = 'flex';
            } else {
                fBtn.style.display = 'none';
            }

            document.getElementById('p-name').innerText = state.currentRivalName;
            nextTurn();
        }

        function nextTurn() {
            clearInterval(state.timer);
            state.timeLeft = 20;
            startTimer();

            // Diff & Repeat Logic
            let pool = DB.filter(q => q.d === state.diff && !state.usedQ.includes(q.id));
            if(pool.length === 0) pool = DB.filter(q => q.d === state.diff); // Relax repeat
            if(pool.length === 0) pool = DB; // Fallback
            
            const q = pool[Math.floor(Math.random() * pool.length)];
            state.usedQ.push(q.id);

            document.getElementById('q-text').innerText = q.q;
            const area = document.getElementById('options-area');
            area.innerHTML = '';

            let idxs = [0,1,2,3].sort(()=>Math.random()-0.5);
            idxs.forEach(i => {
                const b = document.createElement('button');
                b.className = 'opt-btn';
                b.innerText = q.a[i];
                // Store correct status for VAR/Hinchada
                if(i === q.c) b.dataset.correct = "true";
                else b.dataset.correct = "false";
                
                b.onclick = () => answer(i === q.c);
                area.appendChild(b);
            });
        }

        function startTimer() {
            const bar = document.getElementById('ui-timer');
            bar.className = 'timer-fill';
            state.timer = setInterval(() => {
                state.timeLeft--;
                bar.style.width = (state.timeLeft / 20 * 100) + '%';
                if(state.timeLeft < 5) bar.classList.add('danger');
                if(state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    showToast("¬°TIEMPO!", "bad");
                    punish();
                }
            }, 1000);
        }

        function punish() {
            if(state.myG > 0) { state.myG--; showToast("¬°PERDISTE PELOTA!", "bad"); }
            else { state.opG++; showToast("GOL RIVAL", "bad"); }
            state.diff = Math.max(1, state.diff - 1);
            sfx('loss');
            updateScoreboard();
            checkEnd();
            if(!isEnd()) setTimeout(nextTurn, 1000);
        }

        function answer(isCorrect) {
            clearInterval(state.timer);
            if(isCorrect) {
                state.myG++;
                state.diff = Math.min(3, state.diff + 1);
                sfx('win');
                showToast("¬°GOLAZO!", "good");
                db.cash += 5;
                if(state.mode === 'online' && conn) conn.send({type:'goal'});
            } else {
                punish(); return;
            }
            saveData(); updateScoreboard(); checkEnd();
            if(!isEnd()) setTimeout(nextTurn, 1000);
        }

        function handleOpponentGoal() {
            state.opG++;
            updateScoreboard();
            checkEnd();
        }

        function isEnd() { return state.myG >= 10 || state.opG >= 10; } // 10 Goles

        function checkEnd() {
            if(state.myG >= 10) showEnd("¬°GANASTE!", true);
            else if(state.opG >= 10) showEnd("PERDISTE", false);
        }

        function showEnd(msg, win) {
            clearInterval(state.timer);
            // Update History
            if(state.mode === 'online' && state.currentRivalId) {
                if(!db.history[state.currentRivalId]) db.history[state.currentRivalId] = {w:0, l:0};
                if(win) db.history[state.currentRivalId].w++;
                else db.history[state.currentRivalId].l++;
                saveData();
                updateHistoryDisp();
            }

            document.getElementById('end-title').innerText = msg;
            document.getElementById('rematch-status').innerText = "Esperando decisi√≥n...";
            document.getElementById('rematch-modal').style.display = 'flex';
        }

        function updateScoreboard() {
            const draw = (cnt, id) => {
                const el = document.getElementById(id); el.innerHTML='';
                for(let i=0;i<10;i++) el.innerHTML += `<div class="ball ${i<cnt?'active':''}"></div>`;
            };
            draw(state.myG, 'ui-goals-me');
            draw(state.opG, 'ui-goals-op');
        }

        // --- ITEMS ---
        function buyItem(type, price) {
            if(db.cash >= price) { db.cash-=price; db.items[type]++; saveData(); updateUI(); showToast("COMPRADO", "good"); }
            else showToast("FALTA DINERO", "bad");
        }

        function useItem(type) {
            if(db.items[type] > 0) {
                db.items[type]--; saveData(); updateUI();
                const btns = document.querySelectorAll('.opt-btn');
                
                if(type === 'var') {
                    // Logic: Disable 2 WRONG answers
                    let wrong = [];
                    btns.forEach(b => { if(b.dataset.correct === "false") wrong.push(b); });
                    // Shuffle wrong array to pick 2 random
                    wrong.sort(() => Math.random() - 0.5);
                    if(wrong.length >= 2) {
                        wrong[0].disabled = true;
                        wrong[1].disabled = true;
                    }
                    showToast("VAR REVISANDO...", "neutral");
                }
                if(type === 'hinchada') {
                    btns.forEach(b => { if(b.dataset.correct === "true") b.classList.add('correct-hint'); });
                    showToast("LA HINCHADA CANTA...", "good");
                }
                if(type === 'time') { state.timeLeft = 20; showToast("TIEMPO EXTRA", "good"); }
            } else {
                showToast("NO TIENES ITEMS", "bad");
            }
        }

        function quitGame() { clearInterval(state.timer); setScreen('screen-menu'); }
        function requestRematch() {
            state.rematchReq = true;
            document.getElementById('rematch-status').innerText = "Esperando al rival...";
            if(state.mode === 'online' && conn) conn.send({type:'rematch'});
            if(state.mode === 'bot') setTimeout(() => startGame('bot'), 1500); // Bot always accepts
            if(state.rematchReq && state.opRematch) startGame('online');
        }

        updateUI();
    </script>
</body>
</html>
