<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bzn Fut | v17 Hardcore</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --accent: #00f2ff; --bg: #050507; --card-bg: rgba(20, 20, 30, 0.95);
            --border: rgba(255, 255, 255, 0.15); --text: #ffffff;
            --success: #10b981; --danger: #ef4444; --gold: #fbbf24;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Rajdhani', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background-color: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; overflow: hidden; background: radial-gradient(circle at 50% 0%, #1e1b4b, #000); }
        #app { width: 100%; max-width: 480px; height: 100%; display: flex; flex-direction: column; position: relative; padding: 15px; }

        /* SCREENS & ANIMATION */
        .screen { display: none; flex-direction: column; height: 100%; animation: fade 0.3s ease-out; }
        .screen.active { display: flex; }
        @keyframes fade { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        /* UI ELEMENTS */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.6); border-radius: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: center; align-items: center; margin-bottom: 8px; color: white; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(90deg, var(--primary), #4f46e5); box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }
        .btn-glass { background: rgba(255,255,255,0.08); border: 1px solid var(--border); }
        .btn-gold { background: linear-gradient(90deg, #b45309, #f59e0b); color: #000; font-weight: 900; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
        .btn-success { background: var(--success); color: #000; }

        /* GAMEPLAY UI */
        .scoreboard { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 10px; border-radius: 16px; border: 1px solid #333; margin-bottom: 10px; }
        .score-box { text-align: center; width: 45%; }
        .p-name { font-size: 0.8rem; color: #888; display: block; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .dots-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 3px; }
        .dot { width: 8px; height: 8px; background: #222; border-radius: 50%; transition: 0.3s; }
        .dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); transform: scale(1.2); }

        .timer-bar { width: 100%; height: 4px; background: #222; margin-bottom: 10px; border-radius: 2px; }
        .timer-fill { height: 100%; background: var(--primary); transition: width 0.2s linear; }
        .timer-fill.danger { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

        .diff-badge { text-align: center; font-size: 0.7rem; color: #666; margin-bottom: 5px; letter-spacing: 2px; }
        .q-box { min-height: 110px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 1.1rem; font-weight: 700; padding: 10px; line-height: 1.3; }
        
        .opt-btn { width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: #ddd; text-align: left; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; transition: 0.2s; }
        .opt-btn:active { background: var(--accent); color: #000; }
        .opt-btn:disabled { opacity: 0.3; }
        .opt-btn.hint { border: 1px solid var(--success); background: rgba(16, 185, 129, 0.2); }

        /* ITEMS & TAUNTS */
        .taunt-bar { display: flex; gap: 5px; margin-bottom: 10px; justify-content: center; }
        .taunt-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #444; background: #111; font-size: 1.2rem; cursor: pointer; }
        .taunt-btn:active { transform: scale(0.9); border-color: var(--accent); }
        .floating-taunt { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 5rem; z-index: 500; animation: pop 1s forwards; pointer-events: none; text-shadow: 0 0 20px #000; }
        @keyframes pop { 0% {transform:translate(-50%,-50%) scale(0);} 50% {transform:translate(-50%,-50%) scale(1.5);} 100% {transform:translate(-50%,-150%) scale(0); opacity:0;} }

        .items-dock { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding-top: 10px; border-top: 1px solid var(--border); }
        .item-btn { background: #111; border: 1px solid #333; border-radius: 10px; padding: 8px; text-align: center; font-size: 0.7rem; position: relative; color: #888; }
        .item-btn b { display: block; color: var(--gold); font-size: 0.9rem; margin-top: 2px; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: #111; border: 1px solid var(--primary); padding: 30px; border-radius: 20px; text-align: center; width: 100%; max-width: 350px; }

        #toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 8px 24px; border-radius: 30px; font-weight: 800; z-index: 600; box-shadow: 0 0 15px var(--accent); display: none; }
        
        .id-disp { font-family: monospace; font-size: 1.5rem; color: var(--accent); background: #000; padding: 15px; border-radius: 10px; border: 1px dashed #333; margin: 20px 0; }
        .inp { width: 100%; padding: 15px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; text-align: center; font-size: 1.1rem; }
    </style>
</head>
<body>

<div id="toast">MSG</div>
<div id="taunt-layer"></div>

<div id="app">

    <!-- MENU -->
    <div id="screen-menu" class="screen active">
        <div class="top-bar">
            <div><span id="u-name" style="font-weight:bold;">Jugador</span></div>
            <div style="color:var(--gold);">ü™ô <span id="u-coins">0</span></div>
        </div>
        <div class="card" style="text-align:center;">
            <h1 style="font-size:3rem; margin-bottom:5px;">BZN FUT</h1>
            <small style="color:var(--accent); letter-spacing:2px;">v17 HARDCORE</small>
        </div>
        <div style="display:flex; flex-direction:column; gap:8px;">
            <button class="btn btn-gold" onclick="startGame('career')">üèÜ MODO CARRERA</button>
            <button class="btn btn-primary" onclick="goToOnline()">‚öîÔ∏è ONLINE HUB</button>
            <button class="btn btn-glass" onclick="startGame('bot')">ü§ñ VS BOT</button>
            <button class="btn btn-glass" onclick="setScreen('screen-shop')">üõí MERCADO</button>
            <button class="btn btn-glass" onclick="setScreen('screen-settings')">‚öôÔ∏è AJUSTES</button>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="screen-settings" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ VOLVER</span> <span>OPCIONES</span></div>
        <div class="card">
            <p style="margin-bottom:10px; color:#888;">NOMBRE DE USUARIO</p>
            <input id="inp-name" class="inp" placeholder="Tu nombre...">
            <button class="btn btn-primary" style="margin-top:15px;" onclick="saveData(true)">GUARDAR</button>
            <hr style="border-color:#333; margin:20px 0;">
            <button class="btn btn-glass" style="color:var(--danger); border-color:var(--danger);" onclick="resetData()">BORRAR PROGRESO</button>
        </div>
    </div>

    <!-- ONLINE HUB -->
    <div id="screen-online" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ MENU</span> <span>ONLINE</span></div>
        <div class="card">
            <button class="btn btn-primary" onclick="createRoom()">üìù CREAR SALA</button>
            <button class="btn btn-glass" onclick="setScreen('screen-join')">üöÄ UNIRSE</button>
        </div>
        <h4 style="color:#666; margin:10px 0;">AMIGOS</h4>
        <div id="friend-list-container" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- HOST -->
    <div id="screen-host" class="screen" style="text-align:center;">
        <h3 style="margin-top:20px; color:#888;">C√ìDIGO DE SALA</h3>
        <div id="host-id-disp" class="id-disp">...</div>
        <p>Comparte este c√≥digo.</p>
        <button class="btn btn-glass" style="margin-top:auto;" onclick="location.reload()">CANCELAR</button>
    </div>

    <!-- JOIN -->
    <div id="screen-join" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-online')">‚Äπ VOLVER</span></div>
        <div class="card">
            <h3>INGRESAR C√ìDIGO</h3>
            <input id="join-input" class="inp" style="margin:20px 0; text-transform:uppercase;" placeholder="ID DEL RIVAL">
            <button class="btn btn-primary" onclick="connectToPeer()">CONECTAR</button>
        </div>
    </div>

    <!-- GAME -->
    <div id="screen-game" class="screen">
        <div class="diff-badge" id="diff-disp">NIVEL 1: FACIL</div>
        <div style="text-align:center; font-size:0.7rem; color:#666; margin-bottom:5px;" id="hist-disp"></div>

        <div class="scoreboard">
            <div class="score-box">
                <span class="p-name">YO</span>
                <div class="dots-row" id="dots-me"></div>
            </div>
            <div style="font-weight:900;">VS</div>
            <div class="score-box">
                <span class="p-name" id="rival-name">RIVAL</span>
                <div class="dots-row" id="dots-op"></div>
            </div>
        </div>

        <div class="timer-bar"><div class="timer-fill" id="timer-bar"></div></div>

        <!-- Chicanas solo en online -->
        <div class="taunt-bar" id="taunt-area" style="display:none;">
            <button class="taunt-btn" onclick="sendTaunt('üëª')">üëª</button>
            <button class="taunt-btn" onclick="sendTaunt('ü§°')">ü§°</button>
            <button class="taunt-btn" onclick="sendTaunt('ü§´')">ü§´</button>
            <button class="taunt-btn" onclick="sendTaunt('ü•∂')">ü•∂</button>
        </div>

        <div class="card q-box" id="q-text">...</div>
        <div id="options-area" style="display:flex; flex-direction:column;"></div>

        <button id="btn-add-friend" class="btn btn-success" style="display:none; padding:10px; font-size:0.8rem; margin-top:5px;" onclick="sendFriendRequest()">+ AGREGAR A AMIGOS</button>

        <div class="items-dock">
            <div class="item-btn" onclick="useItem('var')">üì∫ VAR <div class="badge" id="b-var">0</div></div>
            <div class="item-btn" onclick="useItem('hint')">üì£ HINCHADA <div class="badge" id="b-hint">0</div></div>
            <div class="item-btn" onclick="useItem('time')">‚è≥ EXTRA <div class="badge" id="b-time">0</div></div>
        </div>
    </div>

    <!-- TIENDA -->
    <div id="screen-shop" class="screen">
        <div class="top-bar"><span onclick="setScreen('screen-menu')">‚Äπ VOLVER</span> <span>MERCADO</span></div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; padding:10px;"><span>üì∫ VAR</span> <button class="btn btn-glass" style="width:auto; padding:5px 15px;" onclick="buyItem('var', 50)">$50</button></div>
            <div style="display:flex; justify-content:space-between; padding:10px;"><span>üì£ HINCHADA</span> <button class="btn btn-glass" style="width:auto; padding:5px 15px;" onclick="buyItem('hint', 40)">$40</button></div>
            <div style="display:flex; justify-content:space-between; padding:10px;"><span>‚è≥ EXTRA</span> <button class="btn btn-glass" style="width:auto; padding:5px 15px;" onclick="buyItem('time', 30)">$30</button></div>
        </div>
    </div>

    <!-- MODAL FIN -->
    <div id="modal-end" class="modal">
        <div class="modal-box">
            <h1 id="end-title" style="font-size:3rem; margin-bottom:10px;">FIN</h1>
            <p id="end-msg" style="color:#888; margin-bottom:20px;">...</p>
            
            <!-- Botones din√°micos seg√∫n modo -->
            <button id="btn-rematch" class="btn btn-primary" onclick="reqRematch()">üîÑ REVANCHA</button>
            <button id="btn-menu" class="btn btn-glass" onclick="quitGame()">MEN√ö PRINCIPAL</button>
            
            <p id="rematch-status" style="color:var(--accent); margin-top:10px; display:none;">Esperando...</p>
        </div>
    </div>

    <!-- MODAL AMISTAD -->
    <div id="modal-friend" class="modal">
        <div class="modal-box">
            <h3>SOLICITUD</h3>
            <p id="friend-req-name" style="color:var(--primary); font-size:1.5rem; margin:10px 0;">...</p>
            <button class="btn btn-success" onclick="acceptFriend()">ACEPTAR</button>
            <button class="btn btn-glass" onclick="document.getElementById('modal-friend').style.display='none'">RECHAZAR</button>
        </div>
    </div>

</div>

<script>
    // --- DB DIFICULTAD (d:1 facil, d:2 medio, d:3 dificil) ---
    const DB = [
        // NIVEL 1 (Popular)
        {d:1, q:"¬øCampe√≥n Qatar 2022?", a:["Argentina","Francia","Brasil","Croacia"], c:0},
        {d:1, q:"¬øClub de Mbapp√©?", a:["Real Madrid","PSG","Liverpool","City"], c:0},
        {d:1, q:"¬øD√≥nde juega Messi?", a:["Inter Miami","PSG","Barcelona","Newell's"], c:0},
        {d:1, q:"¬øApodo de Boca?", a:["Xeneize","Millonario","Rojo","Canalla"], c:0},
        {d:1, q:"¬øDorsal de CR7?", a:["7","10","9","11"], c:0},
        {d:1, q:"¬øEstadio de River?", a:["Monumental","Bombonera","Cilindro","Amalfitani"], c:0},
        {d:1, q:"¬øCampe√≥n Euro 2024?", a:["Espa√±a","Inglaterra","Francia","Alemania"], c:0},
        
        // NIVEL 2 (Hist√≥rico/Datos)
        {d:2, q:"¬øCampe√≥n Libertadores 2024?", a:["Botafogo","Mineiro","River","Pe√±arol"], c:0},
        {d:2, q:"¬øDescenso de River?", a:["2011","2010","2012","2009"], c:0},
        {d:2, q:"¬øGoleador hist√≥rico de Uruguay?", a:["Su√°rez","Cavani","Forl√°n","Francescoli"], c:0},
        {d:2, q:"¬øDT de Argentina 2014?", a:["Sabella","Martino","Pekerman","Maradona"], c:0},
        {d:2, q:"¬øChampions del Madrid (Total)?", a:["15","14","13","16"], c:0},
        {d:2, q:"¬øSede Final Mundial 2026?", a:["MetLife","Azteca","SoFi","Wembley"], c:0},
        {d:2, q:"¬øCampe√≥n Sudamericana 2024?", a:["Racing","Cruzeiro","Lan√∫s","Corinthians"], c:0},

        // NIVEL 3 (Hardcore)
        {d:3, q:"¬øRival Indep. Intercont. 73?", a:["Juventus","Ajax","Milan","Liverpool"], c:0},
        {d:3, q:"¬øQui√©n err√≥ penal Italia 90 vs Arg?", a:["Donadoni/Serena","Baggio","Maldini","Baresi"], c:0},
        {d:3, q:"¬øGoleador Mundial 86?", a:["Lineker","Maradona","Careca","Valdano"], c:0},
        {d:3, q:"¬øDT River 1996?", a:["Ram√≥n D√≠az","Gallego","Passarella","Babington"], c:0},
        {d:3, q:"¬øA√±o fundaci√≥n Boca?", a:["1905","1901","1904","1910"], c:0},
        {d:3, q:"¬øCampe√≥n Metro 1981?", a:["Boca","River","Ferro","Newell's"], c:0}
    ];

    // --- STATE ---
    let db = JSON.parse(localStorage.getItem('bzn_fut_v17')) || {
        name: 'Jugador', coins: 100, items: {var:3, hint:3, time:3}, 
        friends: [], history: {}, careerLvl: 1 // 1:Barrio, 2:Pro, 3:World
    };

    let state = {
        mode: null, myG:0, opG:0, timer:null, timeLeft:20, diff:1,
        rival: {id:null, name:'BOT'}, usedQ: [], 
        rematchMe: false, rematchOp: false, pendingFriend: null
    };

    let peer, conn;

    window.onload = () => {
        setScreen(db.name==='Jugador'?'screen-settings':'screen-menu');
        updateUI();
    };

    // --- UTILS ---
    function setScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='screen-online') renderFriends();
    }

    function updateUI() {
        document.getElementById('u-name').innerText = db.name;
        document.getElementById('u-coins').innerText = db.coins;
        document.getElementById('b-var').innerText = db.items.var;
        document.getElementById('b-hint').innerText = db.items.hint;
        document.getElementById('b-time').innerText = db.items.time;
        document.getElementById('inp-name').value = db.name;
    }

    function saveData(toastShow) { 
        db.name = document.getElementById('inp-name').value;
        localStorage.setItem('bzn_fut_v17', JSON.stringify(db)); 
        updateUI();
        if(toastShow) { toast("GUARDADO"); setScreen('screen-menu'); }
    }
    
    function resetData() { localStorage.removeItem('bzn_fut_v17'); location.reload(); }
    function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 1500); }

    // --- ONLINE ---
    function goToOnline() { setScreen('screen-online'); renderFriends(); }
    function createRoom() {
        setScreen('screen-host');
        const code = 'BZN-'+Math.floor(Math.random()*9999);
        document.getElementById('host-id-disp').innerText = code;
        peer = new Peer(code);
        peer.on('connection', c => { conn = c; setupConn('HOST'); });
    }
    function connectToPeer(tid) {
        const id = tid || document.getElementById('join-input').value.toUpperCase();
        if(!id) return toast("Falta ID");
        peer = new Peer();
        peer.on('open', () => { conn = peer.connect(id); setupConn('CLIENT'); });
    }
    function setupConn(role) {
        conn.on('open', () => { conn.send({type:'hello', name:db.name, id:peer.id}); });
        conn.on('data', d => {
            if(d.type==='hello') {
                state.rival = {id:d.id, name:d.name};
                if(role==='HOST') conn.send({type:'hello', name:db.name, id:peer.id});
                
                // Boton Amigo solo si no es amigo
                const isFriend = db.friends.find(f => f.id === d.id);
                document.getElementById('btn-add-friend').style.display = isFriend ? 'none' : 'block';
                
                startGame('online');
            }
            if(d.type==='goal') handleOpGoal();
            if(d.type==='rematch') { state.rematchOp=true; checkRematch(); }
            if(d.type==='taunt') showTaunt(d.emoji);
            if(d.type==='req_friend') {
                state.pendingFriend = {id:d.id, name:d.name};
                document.getElementById('friend-req-name').innerText = d.name;
                document.getElementById('modal-friend').style.display='flex';
            }
            if(d.type==='acc_friend') {
                if(!db.friends.find(f=>f.id===d.id)) { db.friends.push({id:d.id, name:d.name}); saveData(); toast(d.name+" acept√≥!"); }
            }
        });
    }

    // --- GAME ENGINE ---
    function startGame(mode) {
        state.mode = mode; state.myG = 0; state.opG = 0; state.rematchMe=false; state.rematchOp=false; state.usedQ = [];
        state.diff = 1; // Start Easy

        if(mode !== 'online') {
            state.rival = {id:null, name: mode==='career' ? 'CLUB RIVAL' : 'BOT'};
            document.getElementById('btn-add-friend').style.display = 'none';
            document.getElementById('taunt-area').style.display = 'none';
            document.getElementById('hist-disp').innerText = mode === 'career' ? "MODO CARRERA" : "";
        } else {
            document.getElementById('taunt-area').style.display = 'flex';
            // Historial
            if(state.rival.id) {
                const h = db.history[state.rival.id] || {w:0, l:0};
                document.getElementById('hist-disp').innerText = `HISTORIAL: ${h.w} - ${h.l}`;
            }
        }

        document.getElementById('rival-name').innerText = state.rival.name;
        document.getElementById('modal-end').style.display = 'none';
        document.getElementById('rematch-status').style.display = 'none';
        
        setScreen('screen-game');
        updateScore();
        nextQ();
    }

    function nextQ() {
        clearInterval(state.timer);
        state.timeLeft = 20;
        startTimer();

        // DIFICULTAD PROGRESIVA
        if(state.myG >= 3) state.diff = 2;
        if(state.myG >= 7) state.diff = 3;
        
        const labels = ["", "NIVEL 1: FACIL", "NIVEL 2: MEDIO", "NIVEL 3: DIFICIL"];
        document.getElementById('diff-disp').innerText = labels[state.diff];

        // Filtrar DB
        let pool = DB.filter(q => q.d === state.diff && !state.usedQ.includes(q.q));
        if(pool.length === 0) pool = DB.filter(q => q.d === state.diff); // Relax repeat
        if(pool.length === 0) pool = DB; // Fallback total

        const q = pool[Math.floor(Math.random()*pool.length)];
        state.usedQ.push(q.q);

        document.getElementById('q-text').innerText = q.q;
        const area = document.getElementById('options-area'); area.innerHTML = '';
        
        let idx = [0,1,2,3].sort(()=>Math.random()-0.5);
        idx.forEach(i => {
            const btn = document.createElement('button'); btn.className='opt-btn';
            btn.innerText = q.a[i]; btn.dataset.correct = (i === q.c);
            btn.onclick = () => answer(i === q.c);
            area.appendChild(btn);
        });
    }

    function startTimer() {
        const b = document.getElementById('timer-bar'); b.className='timer-fill';
        state.timer = setInterval(()=>{
            state.timeLeft--; b.style.width=(state.timeLeft/20*100)+'%';
            if(state.timeLeft<=0) { clearInterval(state.timer); punish(); }
        }, 1000);
    }

    function answer(ok) {
        clearInterval(state.timer);
        if(ok) {
            state.myG++; toast("¬°GOL!"); db.coins+=5;
            if(state.mode==='online' && conn) conn.send({type:'goal'});
        } else {
            toast("¬°FALLASTE!"); punish(); return; 
        }
        saveData(); updateScore(); checkEnd();
        if(!isEnd()) setTimeout(nextQ, 1000);
    }

    function punish() {
        if(state.myG>0) state.myG--; else state.opG++;
        updateScore(); checkEnd();
        if(!isEnd()) setTimeout(nextQ, 1000);
    }

    function handleOpGoal() { state.opG++; updateScore(); checkEnd(); }

    function updateScore() {
        drawDots(state.myG, 'dots-me'); drawDots(state.opG, 'dots-op');
    }
    function drawDots(n, id) {
        const el = document.getElementById(id); el.innerHTML='';
        for(let i=0;i<10;i++) el.innerHTML += `<div class="dot ${i<n?'active':''}"></div>`;
    }

    function isEnd() { return state.myG>=10 || state.opG>=10; }
    function checkEnd() { if(state.myG>=10) gameOver(true); else if(state.opG>=10) gameOver(false); }

    function gameOver(win) {
        clearInterval(state.timer);
        const m = document.getElementById('modal-end'); m.style.display='flex';
        document.getElementById('end-title').innerText = win ? "VICTORIA" : "DERROTA";
        document.getElementById('end-msg').innerText = win ? "+50 Monedas" : "Sigue intentando";
        
        // Logica Botones Fin
        const btnRe = document.getElementById('btn-rematch');
        if(state.mode === 'online') {
            btnRe.innerText = "üîÑ PEDIR REVANCHA";
            btnRe.onclick = reqRematch;
        } else {
            btnRe.innerText = "üîÑ JUGAR DE NUEVO";
            btnRe.onclick = () => startGame(state.mode);
        }

        if(win) {
            db.coins += 50;
            // Carrera Logic
            if(state.mode === 'career') {
                if(db.careerLvl < 3) db.careerLvl++;
                toast("¬°ASCENSO EN CARRERA!");
            }
        }
        
        // Historial Online
        if(state.mode === 'online' && state.rival.id) {
            if(!db.history[state.rival.id]) db.history[state.rival.id] = {w:0, l:0};
            if(win) db.history[state.rival.id].w++; else db.history[state.rival.id].l++;
        }
        saveData();
    }

    // --- FEATURES ---
    function reqRematch() {
        state.rematchMe=true; document.getElementById('rematch-status').style.display='block';
        if(conn) conn.send({type:'rematch'});
        checkRematch();
    }
    function checkRematch() { if(state.rematchMe && state.rematchOp) startGame('online'); }
    
    function sendTaunt(e) { if(conn) conn.send({type:'taunt', emoji:e}); showTaunt(e); }
    function showTaunt(e) {
        const d = document.createElement('div'); d.innerText=e; d.className='floating-taunt';
        document.getElementById('taunt-layer').appendChild(d); setTimeout(()=>d.remove(), 2000);
    }

    function buyItem(t,c){ if(db.coins>=c){db.coins-=c; db.items[t]++; saveData(); toast("COMPRADO");} else toast("Falta dinero"); }
    function useItem(t) {
        if(db.items[t]>0){
            db.items[t]--; saveData(); updateUI();
            const btns = document.querySelectorAll('.opt-btn');
            if(t==='var') { let h=0; btns.forEach(b=>{ if(b.dataset.correct==='false' && h<2){b.disabled=true; b.style.opacity=0.2; h++} }); }
            if(t==='hint') btns.forEach(b=>{ if(b.dataset.correct==='true') b.classList.add('hint'); });
            if(t==='time') { clearInterval(state.timer); state.timeLeft=20; startTimer(); }
        } else toast("Sin items");
    }

    // Friend Logic
    function sendFriendRequest() { conn.send({type:'req_friend', id:peer.id, name:db.name}); toast("Enviado"); document.getElementById('btn-add-friend').style.display='none'; }
    function acceptFriend() {
        if(!db.friends.find(f=>f.id===state.pendingFriend.id)) { db.friends.push(state.pendingFriend); saveData(); }
        conn.send({type:'acc_friend', id:peer.id, name:db.name});
        document.getElementById('modal-friend').style.display='none';
    }
    function renderFriends() {
        const c = document.getElementById('friend-list-container'); c.innerHTML='';
        if(db.friends.length===0) c.innerHTML='<p style="text-align:center; color:#666">Sin amigos</p>';
        db.friends.forEach(f => {
            const d = document.createElement('div'); 
            d.style.cssText="padding:10px; background:#111; margin-bottom:5px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;";
            d.innerHTML=`<b>${f.name}</b> <button class="btn-glass" style="width:auto; padding:5px 10px;" onclick="connectToPeer('${f.id}')">INVITAR</button>`;
            c.appendChild(d);
        });
    }

    function quitGame() { clearInterval(state.timer); setScreen('screen-menu'); document.getElementById('modal-end').style.display='none'; }
</script>
</body>
</html>